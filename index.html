<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#020617">
    <meta name="description" content="Wake Map - The Ultimate Execution Protocol">
    <title>Wake Map - Ultimate Architect</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;700&family=Audiowide&display=swap" rel="stylesheet">
    
    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                        display: ['Audiowide', 'cursive'],
                    },
                    colors: {
                        obsidian: "#020617",
                        charcoal: "#0f172a",
                        slate: "#1e293b",
                        iron: "#334155",
                        neonCyan: "#06b6d4",
                        neonPurple: "#8b5cf6",
                        neonGold: "#f59e0b",
                        neonRed: "#ef4444",
                        neonGreen: "#10b981",
                        glass: "rgba(15, 23, 42, 0.65)",
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulseGlow 3s infinite alternate',
                        'shimmer': 'shimmer 2.5s linear infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-6px)' },
                        },
                        pulseGlow: {
                            '0%': { boxShadow: '0 0 5px currentColor' },
                            '100%': { boxShadow: '0 0 20px currentColor' }
                        },
                        shimmer: {
                            '0%': { backgroundPosition: '-200% 0' },
                            '100%': { backgroundPosition: '200% 0' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- CORE STYLESHEET (High-Performance CSS) -->
    <style>
        :root { --ease-expo: cubic-bezier(0.19, 1, 0.22, 1); }
        body { background-color: #020617; color: #e2e8f0; overflow: hidden; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        /* Glassmorphism System */
        .glass-card {
            background: rgba(15, 23, 42, 0.65);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
            transition: all 0.3s var(--ease-expo);
        }
        .glass-card:active { transform: scale(0.98); background: rgba(15, 23, 42, 0.85); }

        /* Button Interactions */
        .btn-action { position: relative; overflow: hidden; transition: all 0.3s var(--ease-expo); }
        .btn-action::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }
        .btn-action:hover::after { left: 100%; }
        .btn-action:active { transform: scale(0.96); }

        /* TIER VISUAL SYSTEM (Strict Implementation) */
        .tier-f { color: #4B5563; filter: grayscale(1); }
        .tier-e { color: #6B7280; filter: none; }
        .tier-d { color: #7C5C3B; }
        .tier-c { color: #4B7F52; text-shadow: 0 1px 2px rgba(75,127,82,0.3); }
        .tier-b { color: #3B82F6; text-shadow: 0 0 8px rgba(59,130,246,0.4); }
        .tier-a { color: #2563EB; text-shadow: 0 0 12px rgba(37,99,235,0.6); }
        .tier-s { color: #7C3AED; text-shadow: 0 0 15px rgba(124,58,237,0.6); }
        .tier-ss { background: linear-gradient(to bottom, #9333EA, #D946EF); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 8px rgba(147,51,234,0.6)); }
        .tier-ex { background: linear-gradient(135deg, #FEF08A 20%, #FACC15 50%, #A16207 80%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 1px 2px rgba(234,179,8,0.5)); }
        .tier-mr { background: linear-gradient(45deg, #CA8A04 0%, #FDE047 50%, #CA8A04 100%); background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: shimmer 4s linear infinite; filter: drop-shadow(0 0 5px rgba(202,138,4,0.6)); }
        .tier-ur { color: #22D3EE; text-shadow: 0 0 5px #fff, 0 0 15px #22D3EE, 0 0 25px #0891B2; animation: glow-pulse 3s infinite; }
        .tier-exr { color: #DC2626; text-shadow: 0 0 10px #EF4444, 0 0 20px #7F1D1D; filter: contrast(1.2); }
        .tier-hs { background: linear-gradient(to right, #B91C1C, #F59E0B, #B91C1C); background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: shimmer 6s linear infinite; filter: drop-shadow(0 0 8px rgba(245,158,11,0.4)); }
        .tier-ps { color: #F9FAFB; text-shadow: 0 0 10px rgba(255,255,255,0.8), 0 0 30px rgba(255,255,255,0.4); }
        .tier-max { background: linear-gradient(to bottom, #FFFFFF 30%, #FDE68A 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 15px #FDE68A, 0 0 40px #F59E0B; position: relative; animation: float 4s ease-in-out infinite; }

        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        @keyframes glow-pulse { 0%, 100% { text-shadow: 0 0 5px currentColor; } 50% { text-shadow: 0 0 20px currentColor, 0 0 10px #fff; } }

        /* Navigation Dock */
        .nav-dock {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.4);
        }
        .nav-item { position: relative; color: #64748b; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .nav-item.active { color: #06b6d4; transform: translateY(-4px); }
        .nav-item.active .nav-icon { filter: drop-shadow(0 4px 8px rgba(6,182,212,0.4)); stroke-width: 2.5px; }
        .nav-indicator { width: 4px; height: 4px; background: #06b6d4; border-radius: 50%; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%) scale(0); transition: transform 0.3s; box-shadow: 0 0 8px #06b6d4; }
        .nav-item.active .nav-indicator { transform: translateX(-50%) scale(1); }

        /* Toast & Overlays */
        #toast-layer { position: fixed; top: 20px; left: 0; right: 0; pointer-events: none; z-index: 100; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .toast-msg { background: rgba(15,23,42,0.95); backdrop-filter: blur(8px); padding: 12px 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 30px rgba(0,0,0,0.5); transform: translateY(-20px); opacity: 0; animation: toastEnter 0.4s forwards; }
        @keyframes toastEnter { to { transform: translateY(0); opacity: 1; } }
        @keyframes toastExit { to { transform: translateY(-20px); opacity: 0; } }

        /* Calendar Grid */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .cal-cell { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-size: 10px; font-weight: bold; border: 1px solid transparent; transition: all 0.2s; position: relative; }
        .cal-cell.active { background: rgba(6,182,212,0.15); border-color: rgba(6,182,212,0.5); color: #fff; }
        .cal-cell:hover { background: rgba(255,255,255,0.05); }

        /* Particle Canvas */
        #particle-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; opacity: 0.3; }
        .ambient-layer { position: fixed; inset: 0; pointer-events: none; z-index: 0; background: radial-gradient(circle at 0% 0%, rgba(6,182,212,0.05) 0%, transparent 50%), radial-gradient(circle at 100% 100%, rgba(139,92,246,0.05) 0%, transparent 50%); }
    </style>
</head>
<body class="font-sans text-sm antialiased text-textMain">

    <!-- APP SHELL -->
    <div id="app-root" class="relative w-full max-w-md mx-auto h-screen flex flex-col bg-obsidian shadow-2xl border-x border-white/5 overflow-hidden">
        
        <!-- Background Systems -->
        <canvas id="particle-canvas"></canvas>
        <div class="ambient-layer"></div>

        <!-- 1. HEADER -->
        <header id="app-header" class="flex-none pt-10 pb-4 px-6 z-20 border-b border-white/5 bg-gradient-to-b from-obsidian via-obsidian/95 to-transparent backdrop-blur-sm">
             <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-black text-white tracking-tight flex items-center gap-2 font-display">
                        <span class="text-neonCyan drop-shadow-[0_0_10px_rgba(6,182,212,0.5)]">WAKE</span>MAP
                    </h1>
                    <!-- UPDATED: CLICK TO REFRESH -->
                    <div onclick="window.location.reload()" class="flex items-center gap-2 mt-1 cursor-pointer group select-none">
                        <span class="relative flex h-2 w-2">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-neonGreen opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-2 w-2 bg-neonGreen"></span>
                        </span>
                        <p id="header-status" class="text-neonCyan/70 text-[10px] font-mono tracking-[0.2em] group-hover:text-neonCyan group-active:text-white transition-colors">TAP TO RELOAD</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="App.controller.openSettings()" class="glass-card p-2 rounded-lg hover:border-neonCyan/50 transition-colors text-slate-400 hover:text-white">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                    </button>
                    <div class="glass-card px-4 py-2 rounded-lg group hover:border-neonCyan/30 transition-colors cursor-default">
                        <span id="header-month" class="text-[10px] font-bold text-white uppercase tracking-[0.15em] group-hover:text-neonCyan transition-colors">...</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- 2. MAIN VIEWPORT (Added overscroll-y-contain for bounce effect) -->
        <main id="app-viewport" class="flex-1 overflow-y-auto overscroll-y-contain px-5 py-6 hide-scroll relative z-10 space-y-8 scroll-smooth">
            <!-- Injected by Router -->
        </main>

        <!-- 3. NAVIGATION -->
        <nav id="app-nav" class="flex-none h-24 px-6 pb-6 pt-2 z-30 bg-gradient-to-t from-obsidian via-obsidian/95 to-transparent pointer-events-none">
            <div id="nav-inner" class="glass-card w-full h-full rounded-2xl flex items-center justify-around px-2 shadow-2xl backdrop-blur-xl pointer-events-auto">
                <!-- Injected by NavComponent -->
            </div>
        </nav>

        <!-- 4. OVERLAYS -->
        <div id="toast-layer"></div>
        <div id="modal-layer" class="fixed inset-0 z-50 pointer-events-none flex items-end sm:items-center justify-center transition-all duration-300 opacity-0 invisible backdrop-blur-sm bg-black/60"></div>

    </div>

    <!-- 
        ========================================================================
        JAVASCRIPT ARCHITECTURE
        ========================================================================
    -->
    <script>
        /**
         * MODULE 1: CONFIGURATION & CONSTANTS
         */
        const Config = {
            APP_NAME: 'Wake Map',
            VERSION: '5.2.0-UX',
            STORAGE_PREFIX: 'wakemap_arch_',
            
            // Time Protocol (Added 'start' for clearer logic)
            TIME_SLOTS: [
                { id: 'halt', label: 'HALT', range: '00:00 - 02:00', start: 0, end: 2, desc: 'Deep Rest & Recovery' },
                { id: 'void', label: 'VOID', range: '02:00 - 04:00', start: 2, end: 4, desc: 'Subconscious Processing' },
                { id: 'boot', label: 'BOOT', range: '04:00 - 06:00', start: 4, end: 6, desc: 'System Initialization' },
                { id: 'prim', label: 'PRIM', range: '06:00 - 08:00', start: 6, end: 8, desc: 'Prime Mental State' },
                { id: 'core', label: 'CORE', range: '08:00 - 10:00', start: 8, end: 10, desc: 'Deep Focus Work' },
                { id: 'flow', label: 'FLOW', range: '10:00 - 12:00', start: 10, end: 12, desc: 'High Performance Flow' },
                { id: 'idle', label: 'IDLE', range: '12:00 - 14:00', start: 12, end: 14, desc: 'System Recharge' },
                { id: 'sync', label: 'SYNC', range: '14:00 - 16:00', start: 14, end: 16, desc: 'Strategic Alignment' },
                { id: 'exec', label: 'EXEC', range: '16:00 - 18:00', start: 16, end: 18, desc: 'Tactical Execution' },
                { id: 'wind', label: 'WIND', range: '18:00 - 20:00', start: 18, end: 20, desc: 'Evening Decompression' },
                { id: 'rest', label: 'REST', range: '20:00 - 22:00', start: 20, end: 22, desc: 'Recovery Mode' },
                { id: 'fade', label: 'FADE', range: '22:00 - 24:00', start: 22, end: 24, desc: 'System Shutdown' },
                { id: 'all',  label: 'ALL',  range: '00:00 - 24:00', start: 0, end: 24, desc: 'Full Day Cycle' }
            ],

            // Rank Definitions
            TIERS: [
                { id:0, code:'F', name:'Failing', class:'tier-f', barColor:'#4B5563' },
                { id:1, code:'E', name:'Elementary', class:'tier-e', barColor:'#6B7280' },
                { id:2, code:'D', name:'Developing', class:'tier-d', barColor:'#7C5C3B' },
                { id:3, code:'C', name:'Capable', class:'tier-c', barColor:'#4B7F52' },
                { id:4, code:'B', name:'Balanced', class:'tier-b', barColor:'#3B82F6' },
                { id:5, code:'A', name:'Advanced', class:'tier-a', barColor:'#2563EB' },
                { id:6, code:'S', name:'Superior', class:'tier-s', barColor:'#7C3AED' },
                { id:7, code:'SS', name:'Supremely Skilled', class:'tier-ss', barColor:'#9333EA' },
                { id:8, code:'EX', name:'Exceptional', class:'tier-ex', barColor:'#FACC15' },
                { id:9, code:'MR', name:'Master Rank', class:'tier-mr', barColor:'#EAB308' },
                { id:10, code:'UR', name:'Ultra Rare', class:'tier-ur', barColor:'#22D3EE' },
                { id:11, code:'EXR', name:'Extreme Rank', class:'tier-exr', barColor:'#DC2626' },
                { id:12, code:'HS', name:'High Spec', class:'tier-hs', barColor:'#F59E0B' },
                { id:13, code:'PS', name:'Peak State', class:'tier-ps', barColor:'#F8FAFB' },
                { id:14, code:'MAX', name:'Maximum', class:'tier-max', barColor:'#FDE68A' }
            ],

            // Difficulty Settings
            DIFFICULTY: {
                easy: { id: 'easy', label: 'Mudah', pts: 2, color: 'text-neonGreen', border: 'border-neonGreen', hex: '#10b981' },
                medium: { id: 'medium', label: 'Sedang', pts: 4, color: 'text-neonCyan', border: 'border-neonCyan', hex: '#06b6d4' },
                hard: { id: 'hard', label: 'Sulit', pts: 6, color: 'text-neonPurple', border: 'border-neonPurple', hex: '#8b5cf6' }
            },

            // Productivity Modes
            PRODUCTIVITY_MODES: [
                { id: 'hibernasi', label: 'Hibernasi', pts: 8, desc: 'Recovery Mode', icon: 'battery-charging', color: 'text-slate-400' },
                { id: 'inisiasi', label: 'Inisiasi', pts: 16, desc: 'Starter', icon: 'sprout', color: 'text-neonGreen' },
                { id: 'standar', label: 'Standar', pts: 24, desc: 'Balanced', icon: 'scale', color: 'text-neonCyan' },
                { id: 'akselerasi', label: 'Akselerasi', pts: 36, desc: 'High Perf', icon: 'zap', color: 'text-neonPurple' },
                { id: 'dominasi', label: 'Dominasi', pts: 50, desc: 'Elite', icon: 'flame', color: 'text-neonRed' },
                { id: 'god', label: 'God Tier', pts: 70, desc: 'Limitless', icon: 'crown', color: 'text-neonGold' }
            ]
        };

        /**
         * MODULE 2: UTILITIES
         */
        class Utils {
            static generateId() { 
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }
            static getISO(d = new Date()) {
                const y = d.getFullYear();
                const m = String(d.getMonth()+1).padStart(2,'0');
                const day = String(d.getDate()).padStart(2,'0');
                return `${y}-${m}-${day}`;
            }
            static getTomorrow() { 
                const d = new Date(); d.setDate(d.getDate()+1); 
                return this.getISO(d); 
            }
            static getMonthKey(iso) {
                return iso.slice(0, 7);
            }
            static formatMonth(iso) { 
                const [y,m]=iso.split('-'); 
                return new Date(y,parseInt(m)-1).toLocaleDateString('id-ID',{month:'long',year:'numeric'}).toUpperCase(); 
            }
            static formatDate(iso) { 
                return new Date(iso).toLocaleDateString('id-ID',{weekday:'long',day:'numeric',month:'long',year:'numeric'}); 
            }
            static formatCurrency(n) { 
                return new Intl.NumberFormat('id-ID').format(n); 
            }
            static getCurrentSlot() {
                const h = new Date().getHours();
                // Find strict slot (not 'all')
                return Config.TIME_SLOTS.find(s => s.id !== 'all' && h >= s.start && h < s.end) || Config.TIME_SLOTS[0];
            }
        }

        /**
         * MODULE 3: DATA SERVICES (MODEL)
         */
        class Store {
            static get(key) { 
                try { 
                    const data = localStorage.getItem(Config.STORAGE_PREFIX + key);
                    // For settings, default is an object, for others array
                    if (key === 'settings') return data ? JSON.parse(data) : { muted: false };
                    return data ? JSON.parse(data) : []; 
                } catch { return key === 'settings' ? { muted: false } : []; } 
            }
            static set(key, data) { 
                localStorage.setItem(Config.STORAGE_PREFIX + key, JSON.stringify(data)); 
            }
        }

        /**
         * MODULE 4: AUDIO SYSTEM (NEW)
         */
        class SoundEngine {
            constructor() {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                const settings = Store.get('settings');
                this.muted = settings ? settings.muted : false;
            }

            setMuted(val) {
                this.muted = val;
                Store.set('settings', { muted: val });
            }

            play(type) {
                if (this.muted) return;
                
                // Resume context if suspended (browser policy)
                if (this.ctx.state === 'suspended') this.ctx.resume();

                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);

                const now = this.ctx.currentTime;

                if (type === 'click') {
                    // Short high pip
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(800, now);
                    osc.frequency.exponentialRampToValueAtTime(300, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    osc.start(now);
                    osc.stop(now + 0.1);
                } else if (type === 'success') {
                    // Ascending major arpeggio
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(440, now); // A4
                    osc.frequency.setValueAtTime(554, now + 0.1); // C#5
                    osc.frequency.setValueAtTime(659, now + 0.2); // E5
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.4);
                    osc.start(now);
                    osc.stop(now + 0.4);
                } else if (type === 'error') {
                    // Low buzz
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.linearRampToValueAtTime(50, now + 0.3);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc.start(now);
                    osc.stop(now + 0.3);
                } else if (type === 'nav') {
                    // Very short soft tick
                     osc.type = 'sine';
                     osc.frequency.setValueAtTime(600, now);
                     gain.gain.setValueAtTime(0.05, now);
                     gain.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
                     osc.start(now);
                     osc.stop(now + 0.05);
                }
            }
        }

        /**
         * MODULE 5: GAME ENGINE (LOGIC)
         */
        class Engine {
            static calcPoints(tasks) {
                const dObj = new Date();
                const today = Utils.getISO(dObj);
                const monthKey = today.slice(0, 7);
                const d = new Date(); d.setMonth(d.getMonth() - 1);
                const prevMonthKey = Utils.getISO(d).slice(0,7);
                
                let cur = 0, mon = 0, last = 0;
                tasks.forEach(t => {
                    if (t.status === 'completed') {
                        const pts = Config.DIFFICULTY[t.difficulty]?.pts || 0;
                        if (t.date === today) cur += pts;
                        if (t.date.startsWith(monthKey)) mon += pts;
                        if (t.date.startsWith(prevMonthKey)) last += pts;
                    }
                });

                // Calculate Average Daily Points for Current Month
                const dayNum = dObj.getDate();
                const avg = dayNum > 0 ? (mon / dayNum).toFixed(1) : '0.0';

                return { cur, mon, last, avg };
            }
            
            static calcRank(monthKey, tasks, financeData) {
                let eTier=0, eBar=0, cTier=0, cBar=0;
                const mTasks = tasks.filter(t => t.date.startsWith(monthKey));
                
                // Get monthly config
                const config = financeData.find(f => f.month === monthKey);
                const dailyTarget = config ? config.targetPts : 10; // Default fallback

                const dates = [...new Set(mTasks.map(t => t.date))].sort();
                
                let eWins = 0;
                let cWins = 0;

                dates.forEach(d => {
                    const ts = mTasks.filter(t => t.date === d);
                    const done = ts.filter(t => t.status === 'completed').length;
                    const total = ts.length;
                    
                    const dayPoints = ts.reduce((acc, t) => acc + (t.status === 'completed' ? Config.DIFFICULTY[t.difficulty].pts : 0), 0);

                    // EXECUTION Logic
                    if (done === total && total > 0) eWins++;
                    
                    // CONSISTENCY Logic
                    if (dayPoints >= dailyTarget) cWins++;
                });

                // Ranking Logic
                const maxTier = Config.TIERS.length - 1;

                let eTierIndex = Math.floor(eWins / 4);
                if (eTierIndex > maxTier) eTierIndex = maxTier;
                let eBars = Math.floor((eWins % 4) / 2);
                if (eTierIndex === maxTier) eBars = 2;

                let cTierIndex = Math.floor(cWins / 4);
                if (cTierIndex > maxTier) cTierIndex = maxTier;
                let cBars = Math.floor((cWins % 4) / 2);
                if (cTierIndex === maxTier) cBars = 2;

                return { 
                    exec: { tier: Config.TIERS[eTierIndex], bars: eBars }, 
                    cons: { tier: Config.TIERS[cTierIndex], bars: cBars },
                    dailyTarget: dailyTarget
                };
            }

            static checkAutoFail(tasks) {
                const h = new Date().getHours();
                const today = Utils.getISO();
                let hasChange = false;

                tasks.forEach(task => {
                    if(task.date === today && task.status === 'pending') {
                        const slot = Config.TIME_SLOTS.find(s => s.id === (task.timeSlot||'all'));
                        if(slot && slot.id !== 'all' && h >= slot.end) {
                            task.status = 'failed';
                            hasChange = true;
                        }
                    }
                });
                return hasChange;
            }
        }

        /**
         * MODULE 6: VISUAL EFFECTS SYSTEM
         */
        class VFXEngine {
            constructor() {
                this.canvas = document.getElementById('particle-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.width = window.innerWidth;
                this.height = window.innerHeight;
                this.particles = [];
                this.init();
            }

            init() {
                this.resize();
                window.addEventListener('resize', () => this.resize());
                for(let i=0; i<40; i++) this.particles.push(this.createParticle());
                this.animate();
            }

            resize() {
                this.width = this.canvas.width = window.innerWidth;
                this.height = this.canvas.height = window.innerHeight;
            }

            createParticle() {
                return {
                    x: Math.random() * this.width,
                    y: Math.random() * this.height,
                    vx: (Math.random() - 0.5) * 0.3,
                    vy: (Math.random() - 0.5) * 0.3,
                    size: Math.random() * 2,
                    alpha: Math.random() * 0.5
                };
            }

            animate() {
                this.ctx.clearRect(0, 0, this.width, this.height);
                this.particles.forEach(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    if(p.x < 0) p.x = this.width;
                    if(p.x > this.width) p.x = 0;
                    if(p.y < 0) p.y = this.height;
                    if(p.y > this.height) p.y = 0;
                    
                    this.ctx.fillStyle = `rgba(6, 182, 212, ${p.alpha})`;
                    this.ctx.beginPath();
                    this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    this.ctx.fill();
                });
                requestAnimationFrame(() => this.animate());
            }
        }

        /**
         * MODULE 7: UI COMPONENT FACTORY
         */
        const ComponentFactory = {
            rankCard(title, data, icon) {
                const t = data.tier;
                const col = t.barColor;
                
                let bars = '';
                for(let i=1; i<=2; i++) {
                    const active = i <= data.bars;
                    const activeStyle = `background-color:${col}; box-shadow: 0 0 10px ${col}, 0 0 20px ${col}; border: 1px solid rgba(255,255,255,0.5);`;
                    const inactiveStyle = `background-color:#1e293b; border: 1px solid rgba(255,255,255,0.05); box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);`;
                    const style = active ? activeStyle : inactiveStyle;
                    
                    bars += `<div class="w-1/2 h-2 rounded-full transition-all duration-500" style="${style}"></div>`;
                }

                return `
                <div class="glass-card p-5 rounded-2xl flex-1 flex flex-col items-center justify-between relative overflow-hidden group min-h-[140px] hover:bg-white/5 transition-colors cursor-default">
                    <div class="absolute inset-0 bg-gradient-to-b from-white/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    
                    <div class="flex items-center justify-between w-full mb-2 z-10">
                        <span class="text-[8px] font-mono text-slate-400 font-bold tracking-widest">${title}</span>
                        <i data-lucide="${icon}" class="w-3 h-3 text-slate-500"></i>
                    </div>

                    <div class="font-display text-5xl mb-2 z-10 transition-all duration-500" style="color:${col}; text-shadow: 0 0 15px ${col};">
                        ${t.code}
                    </div>

                    <div class="text-[9px] text-white font-bold tracking-[0.2em] z-10 mb-4 uppercase opacity-80">${t.name}</div>
                    
                    <div class="flex gap-2 w-full max-w-[80px] z-10">${bars}</div>
                </div>`;
            },

            taskItem(t, isToday) {
                const slot = Config.TIME_SLOTS.find(s=>s.id === (t.timeSlot||'all'));
                const diff = Config.DIFFICULTY[t.difficulty];
                
                let action = '';
                if (isToday && t.status === 'pending') {
                    action = `
                    <div class="flex gap-2">
                        <button onclick="App.controller.updateTask('${t.id}','failed')" class="w-9 h-9 rounded-xl bg-slate/50 border border-neonRed/30 text-neonRed flex items-center justify-center hover:bg-neonRed/20 active:scale-95 transition-all"><i data-lucide="x" class="w-4 h-4"></i></button>
                        <button onclick="App.controller.updateTask('${t.id}','completed')" class="w-9 h-9 rounded-xl bg-slate/50 border border-neonGreen/30 text-neonGreen flex items-center justify-center hover:bg-neonGreen/20 active:scale-95 transition-all shadow-[0_0_10px_rgba(16,185,129,0.2)]"><i data-lucide="check" class="w-4 h-4"></i></button>
                    </div>`;
                } else if (!isToday && t.status === 'pending') {
                    action = `<button onclick="App.controller.deleteTask('${t.id}')" class="text-slate-500 hover:text-neonRed p-2 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
                } else {
                    const icon = t.status === 'completed' ? 'check-circle' : 'x-circle';
                    const col = t.status === 'completed' ? 'text-neonGreen' : 'text-neonRed';
                    action = `<i data-lucide="${icon}" class="${col} w-5 h-5 drop-shadow-lg"></i>`;
                }

                const opacity = t.status === 'pending' ? 'opacity-100' : 'opacity-60 grayscale hover:grayscale-0 transition-all duration-300';
                
                // UPDATED: Failed styling
                const failBg = t.status === 'failed' ? 'bg-neonRed/10 border-neonRed/40 relative overflow-hidden' : '';
                const styleUpcoming = (isToday && t.status === 'pending' && !action.includes('check')) ? 'border-dashed border-slate-700 bg-transparent' : '';
                
                // UPDATED: Text style logic for failed tasks
                const textStyle = t.status === 'failed' ? 'text-neonRed font-bold' : 'text-white font-medium';

                return `
                <div class="glass-card p-4 rounded-xl flex items-center justify-between ${opacity} ${failBg} ${styleUpcoming} mb-3 group hover:border-white/20 transition-all">
                    <div class="flex-1 pr-3">
                        <div class="flex items-center gap-2 mb-1.5">
                            <span class="text-[8px] font-mono font-bold text-slate-300 bg-slate px-1.5 py-0.5 rounded border border-white/5">${slot.label}</span>
                            <span class="text-[8px] font-bold border px-1.5 py-0.5 rounded uppercase ${diff.color} ${diff.border} bg-white/5">${diff.label}</span>
                        </div>
                        <p class="text-sm ${textStyle} leading-snug">${t.text}</p>
                    </div>
                    <div>${action}</div>
                </div>`;
            },

            rankLegend() {
                return Config.TIERS.slice().reverse().map(t => `
                <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-white/5 transition-colors border-b border-white/5 last:border-0">
                    <div class="font-display w-8 text-center text-lg ${t.class}">${t.code}</div>
                    <div class="flex-1">
                        <div class="text-[10px] font-bold text-white uppercase tracking-wider">${t.name}</div>
                    </div>
                </div>`).join('');
            }
        };

        /**
         * MODULE 8: MAIN CONTROLLER
         */
        const Controller = {
            state: {
                view: 'home',
                difficulty: 'easy',
                histMonth: Utils.getISO().slice(0, 7),
                histDate: null,
                tempTask: null,
                rewardStep: 0, 
                tempReward: { name: '', hasPrice: false, price: 0, cost: 0, recs: null },
                showIncomeInput: false,
                tempMode: null,
                // PERSISTENT INPUT STATES
                tempIncome: '',
                tempAlloc: '',
                tempTaskInput: ''
            },

            init() {
                new VFXEngine();
                // Initialize Sound Engine
                this.sound = new SoundEngine();
                
                const monthDisplay = document.getElementById('header-month');
                if (monthDisplay) {
                    monthDisplay.innerText = Utils.formatMonth(Utils.getMonthKey(Utils.getISO()));
                }

                this.render();

                setInterval(() => {
                    const tasks = Store.get('tasks');
                    if (Engine.checkAutoFail(tasks)) {
                        Store.set('tasks', tasks);
                        this.sound.play('error'); // AUDIO
                        this.toast('Waktu misi telah habis!', 'error');
                        if(this.state.view === 'home') this.render();
                    }
                }, 10000);
            },

            // --- NAVIGATION ---
            navigate(view) { 
                this.state.view = view; 
                this.sound.play('nav'); // AUDIO
                this.render(); 
            },
            
            setDifficulty(d) { 
                // Capture input before re-render
                const el = document.getElementById('task-in');
                if(el) this.state.tempTaskInput = el.value;

                this.state.difficulty = d; 
                this.sound.play('click'); // AUDIO
                this.render(); 
            },

            // --- ACTIONS ---
            initTask() {
                const input = document.getElementById('task-in');
                const text = input.value.trim();
                if (!text) { 
                    this.toast('Nama misi wajib diisi', 'error'); 
                    return; 
                }
                this.state.tempTask = { text, difficulty: this.state.difficulty };
                this.state.tempTaskInput = ''; // Clear stored input
                this.openModal();
                input.value = '';
                this.sound.play('click'); // AUDIO
            },

            confirmTask(slotId) {
                if (!this.state.tempTask) return;
                const tasks = Store.get('tasks');
                tasks.push({
                    id: Utils.generateId(),
                    text: this.state.tempTask.text,
                    difficulty: this.state.tempTask.difficulty,
                    timeSlot: slotId,
                    date: Utils.getTomorrow(), 
                    status: 'pending',
                    createdAt: new Date().toISOString()
                });
                Store.set('tasks', tasks);
                this.closeModal();
                this.sound.play('success'); // AUDIO
                this.toast('Misi dijadwalkan besok', 'success');
                this.render();
            },

            updateTask(id, status) {
                const tasks = Store.get('tasks');
                const t = tasks.find(x => x.id === id);
                if (t) {
                    t.status = status;
                    Store.set('tasks', tasks);
                    
                    if (status === 'completed') {
                        this.sound.play('success'); // AUDIO
                        const { mon } = Engine.calcPoints(tasks);
                        const rewards = Store.get('rewards');
                        rewards.forEach(r => {
                            if (r.status === 'active' && mon >= r.cost) {
                                setTimeout(() => {
                                    if(confirm(`Hadiah "${r.name}" tercapai! Klaim?`)) {
                                        r.status = 'redeemed';
                                        r.redeemedDate = Utils.getISO();
                                        Store.set('rewards', rewards);
                                        this.sound.play('success'); // AUDIO
                                        this.toast(`Hadiah "${r.name}" diklaim!`, 'success');
                                        this.render();
                                    }
                                }, 500);
                            }
                        });
                    } else {
                        this.sound.play('error'); // AUDIO
                    }
                    this.render();
                }
            },

            deleteTask(id) {
                if(confirm('Hapus misi ini?')) {
                    const tasks = Store.get('tasks').filter(t => t.id !== id);
                    Store.set('tasks', tasks);
                    this.sound.play('click'); // AUDIO
                    this.toast('Misi dihapus', 'info');
                    this.render();
                }
            },

            saveRef() {
                const val = document.getElementById('ref-in').value.trim();
                if(val) {
                    const refs = Store.get('reflections');
                    const today = Utils.getISO();
                    const ex = refs.find(r => r.date === today);
                    if(ex) ex.text = val; else refs.push({ date: today, text: val });
                    Store.set('reflections', refs);
                    this.sound.play('success'); // AUDIO
                    this.toast('Refleksi tersimpan', 'success');
                    this.render();
                }
            },

            // --- FINANCE & REWARD ACTIONS ---
            selectMode(id) {
                // Capture input before re-render
                const incEl = document.getElementById('income-in');
                const allocEl = document.getElementById('alloc-in');
                
                if(incEl) this.state.tempIncome = incEl.value;
                if(allocEl) this.state.tempAlloc = allocEl.value;

                this.state.tempMode = id;
                this.sound.play('click');
                this.render();
            },

            saveMonthlyConfig() {
                const incomeIn = document.getElementById('income-in').value;
                const allocIn = document.getElementById('alloc-in').value;
                const modeId = this.state.tempMode;
                
                if(!incomeIn || incomeIn <= 0) { this.toast('Nominal gaji tidak valid', 'error'); return; }
                if(!modeId) { this.toast('Pilih mode operasi', 'error'); return; }
                
                // Set default allocation to 20% if not selected
                const allocation = allocIn ? parseFloat(allocIn) : 0.2;

                const mode = Config.PRODUCTIVITY_MODES.find(m => m.id === modeId);
                const finance = Store.get('finance'); 
                const monthKey = Utils.getMonthKey(Utils.getISO());
                const newFinance = finance.filter(f => f.month !== monthKey);
                newFinance.push({ 
                    month: monthKey, 
                    amount: parseInt(incomeIn), 
                    targetPts: mode.pts, 
                    modeId: modeId,
                    allocation: allocation 
                });
                
                Store.set('finance', newFinance);
                this.state.tempIncome = ''; 
                this.state.tempAlloc = '';
                this.state.tempMode = null;
                
                this.sound.play('success'); // AUDIO
                this.toast(`Protokol: ${mode.label.toUpperCase()} diaktifkan!`, 'success');
                this.render();
            },

            initReward() {
                const nameIn = document.getElementById('rew-name').value.trim();
                if(!nameIn) { this.toast('Nama hadiah wajib diisi', 'error'); return; }
                
                this.state.tempReward = { name: nameIn, hasPrice: false, price: 0, cost: 0, recs: null };
                this.state.rewardStep = 1;
                this.sound.play('click'); // AUDIO
                this.render();
            },

            setRewardHasPrice(hasPrice) {
                this.state.tempReward.hasPrice = hasPrice;
                this.state.rewardStep = 2;
                this.sound.play('click'); // AUDIO
                this.render();
            },

            calcRewardRecs() {
                const priceIn = document.getElementById('rew-price').value;
                if (!priceIn || priceIn <= 0) {
                    this.state.tempReward.recs = null;
                    const c = document.getElementById('rec-container');
                    if(c) c.innerHTML = '';
                    return;
                }

                const financeData = Store.get('finance');
                const curMonthKey = Utils.getMonthKey(Utils.getISO());
                const myFinance = financeData.find(f => f.month === curMonthKey);

                if (myFinance) {
                    const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
                    
                    // NEW LOGIC: Calculate based on ALLOCATION percentage
                    const allocation = myFinance.allocation || 0.2; // Default 20%
                    const monthlyBudget = myFinance.amount * allocation;
                    const dailyBudget = monthlyBudget / daysInMonth;
                    
                    const dailyTarget = myFinance.targetPts || 10;
                    
                    // Value per point based on daily reward budget
                    const valPerPoint = Math.max(1, Math.round(dailyBudget / dailyTarget)); 
                    const price = parseInt(priceIn);
                    
                    const normalPts = Math.ceil(price / valPerPoint);
                    const hardPts = Math.ceil(normalPts * 1.5);

                    const recContainer = document.getElementById('rec-container');
                    if (recContainer) {
                        recContainer.innerHTML = `
                        <div class="flex gap-2 mt-2 animate-[fadeIn_0.3s]">
                            <button onclick="App.controller.applyRec(${normalPts})" class="flex-1 bg-slate-800 border border-slate-600 hover:border-neonCyan p-2 rounded-lg text-center transition-all group active:scale-95">
                                <span class="block text-[9px] text-slate-400 uppercase group-hover:text-white">Normal (Fair)</span>
                                <span class="block text-neonCyan font-bold font-mono text-sm">${normalPts} Pts</span>
                            </button>
                            <button onclick="App.controller.applyRec(${hardPts})" class="flex-1 bg-slate-800 border border-slate-600 hover:border-neonPurple p-2 rounded-lg text-center transition-all group active:scale-95">
                                <span class="block text-[9px] text-slate-400 uppercase group-hover:text-white">Sulit (Hemat)</span>
                                <span class="block text-neonPurple font-bold font-mono text-sm">${hardPts} Pts</span>
                            </button>
                        </div>`;
                    }
                } else {
                     const recContainer = document.getElementById('rec-container');
                     if(recContainer) recContainer.innerHTML = `<p class="text-[10px] text-neonRed text-center mt-2">Belum ada data keuangan bulan ini. Cek Menu PETA.</p>`;
                }
            },

            applyRec(pts) {
                const costInput = document.getElementById('rew-cost');
                if (costInput) costInput.value = pts;
                this.sound.play('click'); // AUDIO
            },

            resetRewardForm() {
                this.state.rewardStep = 0;
                this.state.tempReward = { name: '', hasPrice: false, price: 0, cost: 0, recs: null };
                this.sound.play('click'); // AUDIO
                this.render();
            },

            saveReward() {
                const costIn = document.getElementById('rew-cost').value;
                if(!costIn || costIn <= 0) { this.toast('Target poin wajib diisi', 'error'); return; }
                
                let priceVal = 0;
                if(this.state.tempReward.hasPrice) {
                    const priceIn = document.getElementById('rew-price').value;
                    if(!priceIn || priceIn <= 0) { this.toast('Harga nominal wajib diisi', 'error'); return; }
                    priceVal = parseInt(priceIn);
                }

                const r = Store.get('rewards');
                r.push({
                    id: Utils.generateId(),
                    name: this.state.tempReward.name,
                    cost: parseInt(costIn),
                    price: priceVal,
                    status: 'active',
                    redeemedDate: null
                });
                Store.set('rewards', r);
                this.sound.play('success'); // AUDIO
                this.toast('Target ditambahkan', 'success');
                this.resetRewardForm();
            },

            delReward(id) {
                if(confirm('Hapus target?')) {
                    const r = Store.get('rewards').filter(x => x.id !== id);
                    Store.set('rewards', r);
                    this.sound.play('click'); // AUDIO
                    this.render();
                }
            },

            navMonth(offset) {
                const [y, m] = this.state.histMonth.split('-');
                const d = new Date(y, parseInt(m)-1+offset);
                this.state.histMonth = Utils.getISO(d).slice(0, 7);
                this.state.histDate = null;
                this.sound.play('click'); // AUDIO
                this.render();
            },

            setDate(d) {
                this.state.histDate = d;
                this.sound.play('click'); // AUDIO
                this.render();
            },

            // --- SETTINGS & SOUND ---
            openSettings() {
                this.sound.play('click'); // AUDIO
                const m = document.getElementById('modal-layer');
                const isMuted = this.sound.muted;
                m.innerHTML = `
                <div class="bg-charcoal border-t sm:border border-slate-700 rounded-t-3xl sm:rounded-2xl w-full max-w-sm p-6 shadow-2xl pointer-events-auto animate-[slideIn_0.3s_ease-out]">
                    <button onclick="App.controller.closeModal()" class="absolute top-6 right-6 text-slate-500 hover:text-white bg-slate-800/50 p-2 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                    <div class="mb-6"><h3 class="text-xl font-bold text-white mb-1">Pengaturan</h3><p class="text-slate-400 text-xs font-mono">Konfigurasi sistem.</p></div>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-4 rounded-xl bg-slate-800 border border-slate-700">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-neonPurple/10 rounded-lg text-neonPurple"><i data-lucide="${isMuted ? 'volume-x' : 'volume-2'}" class="w-5 h-5"></i></div>
                                <div>
                                    <span class="block text-sm font-bold text-white">Suara Efek (SFX)</span>
                                    <span class="block text-[10px] text-slate-400">${isMuted ? 'Nonaktif' : 'Aktif'}</span>
                                </div>
                            </div>
                            <button onclick="App.controller.toggleSound()" class="w-12 h-6 rounded-full transition-colors relative ${isMuted ? 'bg-slate-600' : 'bg-neonGreen'}">
                                <div class="absolute top-1 w-4 h-4 rounded-full bg-white transition-all ${isMuted ? 'left-1' : 'left-7'}"></div>
                            </button>
                        </div>

                        <button onclick="App.controller.exportData()" class="w-full flex items-center gap-3 p-4 rounded-xl bg-slate-800 border border-slate-700 hover:border-neonCyan transition-all group">
                            <div class="p-2 bg-neonCyan/10 rounded-lg text-neonCyan"><i data-lucide="download" class="w-5 h-5"></i></div>
                            <div class="text-left">
                                <span class="block text-sm font-bold text-white group-hover:text-neonCyan transition-colors">Backup Data</span>
                                <span class="block text-[10px] text-slate-400">Unduh data ke file JSON</span>
                            </div>
                        </button>
                        <button onclick="App.controller.importData()" class="w-full flex items-center gap-3 p-4 rounded-xl bg-slate-800 border border-slate-700 hover:border-neonGreen transition-all group">
                            <div class="p-2 bg-neonGreen/10 rounded-lg text-neonGreen"><i data-lucide="upload" class="w-5 h-5"></i></div>
                            <div class="text-left">
                                <span class="block text-sm font-bold text-white group-hover:text-neonGreen transition-colors">Restore Data</span>
                                <span class="block text-[10px] text-slate-400">Pulihkan dari file JSON</span>
                            </div>
                        </button>
                        <button onclick="if(confirm('Yakin ingin menghapus SEMUA data? Aksi ini tidak bisa dibatalkan.')) { localStorage.clear(); location.reload(); }" class="w-full flex items-center gap-3 p-4 rounded-xl bg-slate-800 border border-slate-700 hover:border-neonRed transition-all group mt-6">
                            <div class="p-2 bg-neonRed/10 rounded-lg text-neonRed"><i data-lucide="trash-2" class="w-5 h-5"></i></div>
                            <div class="text-left">
                                <span class="block text-sm font-bold text-white group-hover:text-neonRed transition-colors">Reset Total</span>
                                <span class="block text-[10px] text-slate-400">Hapus semua progress</span>
                            </div>
                        </button>
                    </div>
                </div>`;
                m.classList.remove('opacity-0', 'invisible', 'pointer-events-none');
                lucide.createIcons();
            },

            toggleSound() {
                const newState = !this.sound.muted;
                this.sound.setMuted(newState);
                this.openSettings(); // Refresh modal UI
                if (!newState) this.sound.play('click');
            },

            exportData() {
                this.sound.play('click');
                const data = {
                    tasks: Store.get('tasks'),
                    rewards: Store.get('rewards'),
                    reflections: Store.get('reflections'),
                    finance: Store.get('finance'),
                    settings: Store.get('settings')
                };
                const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `wakemap_backup_${Utils.getISO()}.json`;
                a.click();
                this.toast('Data berhasil di-backup!', 'success');
            },

            importData() {
                this.sound.play('click');
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = e => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = event => {
                        try {
                            const data = JSON.parse(event.target.result);
                            if (data.tasks) Store.set('tasks', data.tasks);
                            if (data.rewards) Store.set('rewards', data.rewards);
                            if (data.reflections) Store.set('reflections', data.reflections);
                            if (data.finance) Store.set('finance', data.finance);
                            if (data.settings) Store.set('settings', data.settings);
                            this.sound.play('success');
                            this.toast('Data berhasil dipulihkan!', 'success');
                            setTimeout(() => window.location.reload(), 1000);
                        } catch (err) {
                            this.sound.play('error');
                            this.toast('File backup tidak valid', 'error');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            },

            // --- UI HELPERS ---
            toast(msg, type='info') {
                if (type === 'error') this.sound.play('error');
                // Success sound is usually played before calling toast for specific actions
                
                const el = document.getElementById('toast-layer');
                const div = document.createElement('div');
                const cls = { success:'border-neonGreen text-neonGreen', error:'border-neonRed text-neonRed', info:'border-neonCyan text-neonCyan' };
                const ico = { success:'check-circle', error:'alert-circle', info:'info' };
                div.className = `toast-msg border-l-4 ${cls[type]}`;
                div.innerHTML = `<i data-lucide="${ico[type]}" class="w-5 h-5"></i><span class="text-xs font-bold text-white">${msg}</span>`;
                el.appendChild(div);
                lucide.createIcons();
                setTimeout(() => { div.style.animation = 'toastExit 0.4s forwards'; setTimeout(()=>div.remove(), 400); }, 3000);
            },

            openModal() {
                this.sound.play('click');
                const m = document.getElementById('modal-layer');
                m.innerHTML = `
                <div class="bg-charcoal border-t sm:border border-slate-700 rounded-t-3xl sm:rounded-2xl w-full max-w-sm p-6 shadow-2xl pointer-events-auto animate-[slideIn_0.3s_ease-out]">
                    <button onclick="App.controller.closeModal()" class="absolute top-6 right-6 text-slate-500 hover:text-white bg-slate-800/50 p-2 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                    <div class="mb-6"><h3 class="text-xl font-bold text-white mb-1">Time Protocol</h3><p class="text-slate-400 text-xs font-mono">Pilih slot waktu eksekusi:</p></div>
                    <div class="grid grid-cols-2 gap-2 h-64 overflow-y-auto custom-scroll pr-1">
                        ${Config.TIME_SLOTS.map(s => `<button onclick="App.controller.confirmTask('${s.id}')" class="glass-card p-3 rounded-xl hover:border-neonCyan hover:bg-slate-800 text-left group active:scale-95 transition-all"><span class="text-neonCyan font-mono font-bold text-sm block group-hover:text-white transition-colors">${s.label}</span><span class="text-slate-300 text-[10px] block opacity-70">${s.range}</span></button>`).join('')}
                    </div>
                </div>`;
                m.classList.remove('opacity-0', 'invisible', 'pointer-events-none');
                lucide.createIcons();
            },

            closeModal() {
                this.sound.play('click');
                const m = document.getElementById('modal-layer');
                m.classList.add('opacity-0', 'invisible', 'pointer-events-none');
                setTimeout(() => m.innerHTML='', 300);
            },

            // --- RENDER ENGINE ---
            render() {
                // 1. Pre-Check Auto Fails before rendering
                const tasksRaw = Store.get('tasks');
                if(Engine.checkAutoFail(tasksRaw)) { Store.set('tasks', tasksRaw); }

                const tasks = Store.get('tasks');
                const rewards = Store.get('rewards');
                const reflections = Store.get('reflections');
                const financeData = Store.get('finance'); // Array of monthly finance
                
                const today = Utils.getISO();
                const monthKey = Utils.getISO().slice(0, 7);
                const currentSlot = Utils.getCurrentSlot();
                const currentHour = new Date().getHours();
                
                // Get Current Month Config
                const myFinance = financeData.find(f => f.month === monthKey);
                
                // Update Common Elements
                document.getElementById('header-month').innerText = Utils.formatMonth(monthKey);
                
                // Update Nav
                const navInner = document.getElementById('nav-inner');
                const tabs = [{id:'home',l:'PETA',i:'map'},{id:'rank',l:'RANK',i:'swords'},{id:'rewards',l:'GIFT',i:'gift'},{id:'history',l:'LOGS',i:'history'}];
                navInner.innerHTML = tabs.map(t => {
                    const act = this.state.view === t.id;
                    return `<button onclick="App.controller.navigate('${t.id}')" class="nav-item ${act?'active':''} flex flex-col items-center gap-1.5 p-2 w-16 group"><i data-lucide="${t.i}" class="nav-icon w-5 h-5"></i><span class="text-[8px] font-bold tracking-widest group-hover:text-white">${t.l}</span><div class="nav-indicator"></div></button>`;
                }).join('');

                const main = document.getElementById('app-viewport');
                
                // CALCULATE STATS GLOBAL (Used in Home & Logs)
                const pts = Engine.calcPoints(tasks);

                if (this.state.view === 'home') {
                    const rnk = Engine.calcRank(monthKey, tasks, financeData);
                    const ref = reflections.find(r => r.date === today);
                    
                    // --- LOGIC FILTER BARU ---
                    const tFailed = tasks.filter(t => t.date === today && t.status === 'failed');
                    const tCompleted = tasks.filter(t => t.date === today && t.status === 'completed');
                    const tActive = tasks.filter(t => {
                        return t.date === today && t.status === 'pending' && (t.timeSlot === currentSlot.id || t.timeSlot === 'all');
                    });
                    const tUpcoming = tasks.filter(t => {
                        if (t.date !== today || t.status !== 'pending') return false;
                        const slot = Config.TIME_SLOTS.find(s => s.id === t.timeSlot);
                        return slot && slot.id !== 'all' && slot.start > currentHour; 
                    });
                    const tTom = tasks.filter(t => t.date === Utils.getTomorrow());

                    // UPDATED: Calculate potential points for tomorrow
                    const tTomPoints = tTom.reduce((acc, t) => acc + (Config.DIFFICULTY[t.difficulty]?.pts || 0), 0);

                    const diffBtn = (d) => {
                        const act = this.state.difficulty === d;
                        const c = Config.DIFFICULTY[d];
                        return `<button onclick="App.controller.setDifficulty('${d}')" class="flex-1 py-2 rounded-lg text-[10px] font-bold border uppercase transition-all ${act ? `bg-white/10 text-white shadow-[0_0_10px_currentColor] ${c.border}` : 'border-slate-700 text-slate-500'}" style="${act?`color:${c.hex}`:''}">${c.label}</button>`;
                    };

                    // --- FINANCE SETUP CARD (HOME) ---
                    let financeCard = '';
                    if (!myFinance) {
                        const selectedModeId = this.state.tempMode;
                        financeCard = `
                        <div class="glass-card p-5 rounded-xl border border-neonGold/30 bg-neonGold/5 mb-4 animate-[pulse-slow]">
                            <div class="flex items-center gap-2 mb-3">
                                <i data-lucide="settings-2" class="w-5 h-5 text-neonGold"></i>
                                <h3 class="text-sm font-bold text-white">Kalibrasi Protokol Bulan Ini</h3>
                            </div>
                            <p class="text-xs text-slate-400 mb-3 leading-relaxed">Agar kalkulasi nilai poin & rank akurat, masukkan parameter finansial & pilih mode operasi Anda.</p>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-[9px] text-slate-500 uppercase font-bold mb-1 block">Anggaran/Gaji (Rp)</label>
                                    <input id="income-in" type="number" placeholder="Contoh: 1800000" value="${this.state.tempIncome || ''}" class="w-full bg-obsidian text-white rounded-lg px-3 py-2.5 text-sm border border-slate-700 focus:border-neonGold outline-none transition-colors">
                                </div>
                                <div>
                                    <label class="text-[9px] text-slate-500 uppercase font-bold mb-1 block">Alokasi Self Reward (%)</label>
                                    <select id="alloc-in" class="w-full bg-obsidian text-white rounded-lg px-3 py-2.5 text-sm border border-slate-700 focus:border-neonGold outline-none transition-colors">
                                        <option value="0.1" ${this.state.tempAlloc === '0.1' ? 'selected' : ''}>10% (Mode Hemat)</option>
                                        <option value="0.2" ${this.state.tempAlloc === '0.2' || !this.state.tempAlloc ? 'selected' : ''}>20% (Mode Wajar)</option>
                                        <option value="0.3" ${this.state.tempAlloc === '0.3' ? 'selected' : ''}>30% (Mode Sultan)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-[9px] text-slate-500 uppercase font-bold mb-2 block">Pilih Mode Operasi</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        ${Config.PRODUCTIVITY_MODES.map(m => {
                                            const isSel = selectedModeId === m.id;
                                            const border = isSel ? `border-${m.color.split('-')[1]}` : 'border-slate-700';
                                            const bg = isSel ? 'bg-slate-700' : 'bg-slate-800';
                                            return `
                                            <button onclick="App.controller.selectMode('${m.id}')" class="${bg} border ${border} hover:bg-slate-700 p-2 rounded-lg text-left transition-all active:scale-95 group relative overflow-hidden">
                                                ${isSel ? `<div class="absolute inset-0 bg-white/5"></div>` : ''}
                                                <div class="flex items-center gap-2 mb-1">
                                                    <i data-lucide="${m.icon}" class="w-3 h-3 ${m.color}"></i>
                                                    <span class="text-xs font-bold text-white">${m.label}</span>
                                                </div>
                                                <div class="flex justify-between items-center">
                                                    <span class="text-[9px] text-slate-400">${m.desc}</span>
                                                    <span class="text-[10px] font-mono font-bold ${m.color}">${m.pts} Pts</span>
                                                </div>
                                            </button>`;
                                        }).join('')}
                                    </div>
                                </div>
                                <button onclick="App.controller.saveMonthlyConfig()" class="w-full bg-neonGold text-obsidian px-4 py-3 rounded-lg font-bold hover:bg-white transition-colors shadow-lg mt-2 flex justify-center items-center gap-2"><i data-lucide="check-circle" class="w-4 h-4"></i> Simpan Parameter</button>
                            </div>
                        </div>`;
                    }

                    main.innerHTML = `
                    <div class="space-y-8 pb-10 animate-[fadeIn_0.4s_ease-out]">
                        
                        ${financeCard}

                        <div class="flex gap-4">${ComponentFactory.rankCard('EXECUTION', rnk.exec, 'swords')}${ComponentFactory.rankCard('CONSISTENCY', rnk.cons, 'zap')}</div>
                        
                        <!-- Poin Hari Ini -->
                        <div class="glass-card p-5 rounded-xl flex items-center justify-between relative overflow-hidden">
                            <div class="absolute right-0 top-0 h-full w-1/2 bg-gradient-to-l from-neonCyan/10 to-transparent"></div>
                            <div class="relative z-10"><div class="text-[9px] text-neonCyan font-bold uppercase tracking-widest mb-1">Poin Hari Ini</div><div class="text-4xl font-mono font-bold text-white drop-shadow-md">${pts.cur} <span class="text-xs text-slate-500 font-sans font-normal">/ ${myFinance ? myFinance.targetPts : '-'} PTS</span></div></div>
                            <div class="relative z-10 w-12 h-12 rounded-full bg-slate border border-white/10 flex items-center justify-center"><i data-lucide="activity" class="text-neonCyan w-6 h-6"></i></div>
                        </div>

                        <!-- Rata-rata Harian (New) -->
                        <div class="glass-card p-3 rounded-xl flex items-center justify-between border-l-2 border-neonPurple bg-white/5">
                            <div class="flex items-center gap-3">
                                <div class="p-2 rounded-lg bg-neonPurple/10"><i data-lucide="trending-up" class="w-4 h-4 text-neonPurple"></i></div>
                                <div>
                                    <p class="text-[9px] text-neonPurple font-bold uppercase tracking-widest">Rata-rata Harian</p>
                                    <p class="text-[8px] text-slate-400 font-mono">Performa Bulan Ini</p>
                                </div>
                            </div>
                            <div class="text-xl font-mono font-bold text-white tracking-wide">${pts.avg} <span class="text-[9px] text-slate-500 font-sans font-normal">PTS</span></div>
                        </div>

                        <!-- Stats Bulanan Grid (2 Columns) -->
                        <div class="grid grid-cols-2 gap-3">
                            <div class="glass-card p-4 flex flex-col items-center border-t-2 border-slate-600">
                                <span class="text-[8px] text-slate-400 uppercase tracking-widest mb-1">Bulan Lalu</span>
                                <span class="text-xl font-mono font-bold text-slate-300">${pts.last}</span>
                            </div>
                            <div class="glass-card p-4 flex flex-col items-center border-t-2 border-neonCyan">
                                <span class="text-[8px] text-neonCyan uppercase tracking-widest mb-1">Bulan Ini</span>
                                <span class="text-xl font-mono font-bold text-white">${pts.mon}</span>
                            </div>
                        </div>

                        ${ref ? `<div class="glass-card p-5 rounded-xl border-l-4 border-l-neonPurple"><div class="flex items-center gap-2 mb-2 text-neonPurple"><i data-lucide="brain-circuit" class="w-4 h-4"></i><span class="text-[10px] font-bold uppercase tracking-widest">LOG REFLEKSI</span></div><p class="text-sm text-slate-200 italic">"${ref.text}"</p></div>` : 
                        `<div class="p-5 rounded-xl border border-dashed border-slate-700 bg-slate/20"><label class="block text-slate-400 text-[10px] font-bold mb-3 uppercase tracking-widest flex items-center gap-2"><i data-lucide="edit-3" class="w-3 h-3"></i> Refleksi Wajib</label><div class="flex gap-2"><input id="ref-in" type="text" placeholder="Apa yang dipelajari?" class="flex-1 bg-charcoal text-white rounded-lg px-4 py-3 text-sm border border-slate-700 focus:border-neonPurple outline-none"><button onclick="App.controller.saveRef()" class="bg-neonPurple text-white px-4 rounded-lg shadow-lg"><i data-lucide="save" class="w-4 h-4"></i></button></div></div>`}

                        <!-- SECTION: MISI GAGAL (Hanya muncul jika ada) -->
                        ${tFailed.length > 0 ? `
                        <div>
                             <div class="flex justify-between mb-2 items-center border-b border-neonRed/20 pb-2">
                                <h2 class="text-sm font-bold text-neonRed flex items-center gap-2"><i data-lucide="alert-octagon" class="w-4 h-4"></i> TERLEWAT / GAGAL</h2>
                            </div>
                            <div class="space-y-0">${tFailed.map(t => ComponentFactory.taskItem(t, true)).join('')}</div>
                        </div>` : ''}

                         <!-- SECTION: MISI SELESAI (NEW) -->
                        ${tCompleted.length > 0 ? `
                        <div>
                             <div class="flex justify-between mb-2 items-center border-b border-neonGreen/20 pb-2">
                                <h2 class="text-sm font-bold text-neonGreen flex items-center gap-2"><i data-lucide="check-circle-2" class="w-4 h-4"></i> SELESAI / SUKSES</h2>
                            </div>
                            <div class="space-y-0 opacity-90">${tCompleted.map(t => ComponentFactory.taskItem(t, true)).join('')}</div>
                        </div>` : ''}

                        <!-- SECTION: MISI AKTIF -->
                        <div>
                            <div class="flex justify-between mb-4 items-end border-b border-white/5 pb-2">
                                <h2 class="text-sm font-bold text-white flex items-center gap-2"><i data-lucide="crosshair" class="w-4 h-4 text-neonCyan"></i> MISI AKTIF</h2>
                                <div class="flex flex-col items-end">
                                    <span class="text-[9px] text-neonCyan font-mono font-bold uppercase tracking-widest">${currentSlot.label} PHASE</span>
                                    <span class="text-[8px] text-slate-500 font-mono">${currentSlot.range}</span>
                                </div>
                            </div>
                            <div class="space-y-0">${tActive.length===0 ? '<div class="text-center py-8 text-xs text-slate-600 font-mono border border-dashed border-slate-800 rounded-xl">ISTIRAHAT / FASE KOSONG</div>' : tActive.map(t => ComponentFactory.taskItem(t, true)).join('')}</div>
                        </div>

                        <!-- SECTION: MISI AKAN DATANG (Hanya muncul jika ada) -->
                        ${tUpcoming.length > 0 ? `
                        <div>
                             <div class="flex justify-between mb-2 items-center border-b border-neonPurple/20 pb-2">
                                <h2 class="text-sm font-bold text-neonPurple flex items-center gap-2"><i data-lucide="clock" class="w-4 h-4"></i> AKAN DATANG HARI INI</h2>
                            </div>
                            <div class="space-y-0 opacity-80">${tUpcoming.map(t => ComponentFactory.taskItem(t, true)).join('')}</div>
                        </div>` : ''}

                        <div class="flex items-center justify-center opacity-20 py-2"><div class="h-px bg-white w-full"></div><div class="mx-4 text-[9px] font-mono text-white whitespace-nowrap">NEXT CYCLE</div><div class="h-px bg-white w-full"></div></div>

                        <!-- SECTION: PERENCANAAN BESOK -->
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-sm font-bold text-white flex items-center gap-2"><i data-lucide="sunrise" class="w-4 h-4 text-neonGold"></i> PERENCANAAN BESOK</h2>
                                <span class="text-[10px] font-mono text-neonGold border border-neonGold/30 px-2 py-1 rounded bg-neonGold/10">POTENSI: +${tTomPoints} PTS</span>
                            </div>
                            <div class="glass-card p-5 rounded-xl space-y-4 mb-4">
                                <input id="task-in" type="text" placeholder="Input nama misi..." value="${this.state.tempTaskInput || ''}" class="w-full bg-charcoal text-white rounded-lg px-4 py-3 text-sm border border-slate-700 focus:border-neonCyan outline-none">
                                <div class="flex gap-2">${['easy','medium','hard'].map(diffBtn).join('')}</div>
                                <button onclick="App.controller.initTask()" class="w-full btn-action bg-neonCyan hover:bg-white hover:text-obsidian text-obsidian font-bold py-3 rounded-lg text-xs uppercase tracking-widest shadow-[0_0_15px_rgba(6,182,212,0.3)] flex justify-center gap-2"><i data-lucide="plus-circle" class="w-4 h-4"></i> Jadwalkan</button>
                            </div>
                            <div class="space-y-0">${tTom.map(t => ComponentFactory.taskItem(t, false)).join('')}</div>
                        </div>
                    </div>`;
                } 
                else if (this.state.view === 'rank') {
                    const rnk = Engine.calcRank(monthKey, tasks, financeData);
                    let hHtml = '';
                    for(let i=1; i<=3; i++) {
                        const d = new Date(); d.setMonth(d.getMonth()-i);
                        const k = Utils.getISO(d).slice(0,7);
                        const r = Engine.calcRank(k, tasks, financeData);
                        hHtml += `
                        <div class="glass-card px-4 py-3 rounded-xl flex items-center justify-between mb-2">
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">${Utils.formatMonth(k)}</span>
                            <div class="flex gap-4">
                                <div class="flex items-center gap-2" title="Execution Rank">
                                    <span class="text-[8px] font-mono text-slate-600">EXEC</span>
                                    <span class="font-display text-base ${r.exec.tier.class}">${r.exec.tier.code}</span>
                                </div>
                                <div class="w-px h-4 bg-white/5"></div>
                                <div class="flex items-center gap-2" title="Consistency Rank">
                                    <span class="text-[8px] font-mono text-slate-600">CONS</span>
                                    <span class="font-display text-base ${r.cons.tier.class}">${r.cons.tier.code}</span>
                                </div>
                            </div>
                        </div>`;
                    }
                    main.innerHTML = `
                    <div class="space-y-8 animate-[fadeIn_0.4s_ease-out] pt-4">
                        <div class="text-center"><div class="inline-block px-6 py-2 rounded-full border border-neonCyan/30 bg-neonCyan/10 backdrop-blur-md mb-2"><h2 class="text-neonCyan font-black text-sm uppercase tracking-[0.2em] drop-shadow-[0_0_10px_rgba(6,182,212,0.5)]">${Utils.formatMonth(monthKey)}</h2></div><p class="text-[10px] text-slate-500 uppercase tracking-widest">Laporan Kinerja Bulanan</p></div>
                        <div class="flex flex-col gap-4">${ComponentFactory.rankCard('EXECUTION RANK', rnk.exec, 'swords')}<div class="text-center text-[9px] text-slate-500 font-mono -mt-2 mb-2">SYARAT: SEMUA SELESAI (2x)</div>${ComponentFactory.rankCard('CONSISTENCY RANK', rnk.cons, 'zap')}<div class="text-center text-[9px] text-slate-500 font-mono -mt-2">SYARAT: CAPAI TARGET HARIAN (${rnk.dailyTarget} PTS)</div></div>
                        <div class="pt-4 border-t border-white/5"><h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2"><i data-lucide="archive" class="w-3 h-3"></i> Arsip Bulanan</h3>${hHtml}</div>
                        <div class="pt-4 border-t border-white/5"><h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2"><i data-lucide="list" class="w-3 h-3"></i> Codex Pangkat</h3><div class="bg-charcoal/50 p-2 rounded-xl border border-white/5 h-64 overflow-y-auto custom-scroll">${ComponentFactory.rankLegend()}</div></div>
                    </div>`;
                }
                else if (this.state.view === 'rewards') {
                    // Uses pts calculated globally at start of render
                    const { mon } = pts;
                    const active = rewards.filter(r => r.status === 'active');
                    const redeemed = rewards.filter(r => r.status === 'redeemed').sort((a,b)=>new Date(b.redeemedDate)-new Date(a.redeemedDate));
                    
                    // --- FINANCE LOGIC ---
                    const curMonthKey = Utils.getMonthKey(Utils.getISO());
                    const myFinance = financeData.find(f => f.month === curMonthKey);
                    
                    let financeSection = '';
                    if (!myFinance) {
                        const selectedModeId = this.state.tempMode;
                        financeSection = `
                        <div class="glass-card p-5 rounded-xl border border-neonGold/30 bg-neonGold/5 mb-4 animate-[pulse-slow]">
                            <div class="flex items-center gap-2 mb-3">
                                <i data-lucide="settings-2" class="w-5 h-5 text-neonGold"></i>
                                <h3 class="text-sm font-bold text-white">Kalibrasi Protokol Bulan Ini</h3>
                            </div>
                            <p class="text-xs text-slate-400 mb-3 leading-relaxed">Agar kalkulasi nilai poin & rank akurat, masukkan parameter finansial & pilih mode operasi Anda.</p>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-[9px] text-slate-500 uppercase font-bold mb-1 block">Anggaran/Gaji (Rp)</label>
                                    <input id="income-in" type="number" placeholder="Contoh: 1800000" value="${this.state.tempIncome || ''}" class="w-full bg-obsidian text-white rounded-lg px-3 py-2.5 text-sm border border-slate-700 focus:border-neonGold outline-none transition-colors">
                                </div>
                                <div>
                                    <label class="text-[9px] text-slate-500 uppercase font-bold mb-1 block">Alokasi Self Reward (%)</label>
                                    <select id="alloc-in" class="w-full bg-obsidian text-white rounded-lg px-3 py-2.5 text-sm border border-slate-700 focus:border-neonGold outline-none transition-colors">
                                        <option value="0.1" ${this.state.tempAlloc === '0.1' ? 'selected' : ''}>10% (Mode Hemat)</option>
                                        <option value="0.2" ${this.state.tempAlloc === '0.2' || !this.state.tempAlloc ? 'selected' : ''}>20% (Mode Wajar)</option>
                                        <option value="0.3" ${this.state.tempAlloc === '0.3' ? 'selected' : ''}>30% (Mode Sultan)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-[9px] text-slate-500 uppercase font-bold mb-2 block">Pilih Mode Operasi</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        ${Config.PRODUCTIVITY_MODES.map(m => {
                                            const isSel = selectedModeId === m.id;
                                            const border = isSel ? `border-${m.color.split('-')[1]}` : 'border-slate-700';
                                            const bg = isSel ? 'bg-slate-700' : 'bg-slate-800';
                                            return `
                                            <button onclick="App.controller.selectMode('${m.id}')" class="${bg} border ${border} hover:bg-slate-700 p-2 rounded-lg text-left transition-all active:scale-95 group relative overflow-hidden">
                                                ${isSel ? `<div class="absolute inset-0 bg-white/5"></div>` : ''}
                                                <div class="flex items-center gap-2 mb-1">
                                                    <i data-lucide="${m.icon}" class="w-3 h-3 ${m.color}"></i>
                                                    <span class="text-xs font-bold text-white">${m.label}</span>
                                                </div>
                                                <div class="flex justify-between items-center">
                                                    <span class="text-[9px] text-slate-400">${m.desc}</span>
                                                    <span class="text-[10px] font-mono font-bold ${m.color}">${m.pts} Pts</span>
                                                </div>
                                            </button>`;
                                        }).join('')}
                                    </div>
                                </div>
                                <button onclick="App.controller.saveMonthlyConfig()" class="w-full bg-neonGold text-obsidian px-4 py-3 rounded-lg font-bold hover:bg-white transition-colors shadow-lg mt-2 flex justify-center items-center gap-2"><i data-lucide="check-circle" class="w-4 h-4"></i> Simpan Parameter</button>
                            </div>
                        </div>`;
                    } else {
                        // Info Valuasi Kecil
                        const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
                        const allocation = myFinance.allocation || 0.2;
                        const dailyBudget = (myFinance.amount * allocation) / daysInMonth;
                        
                        const dailyTarget = myFinance.targetPts || 10;
                        const valPerPoint = Math.max(1, Math.round(dailyBudget / dailyTarget));
                        
                        const mode = Config.PRODUCTIVITY_MODES.find(m => m.id === myFinance.modeId) || { label: 'Custom', color: 'text-white' };
                        
                        financeSection = `
                        <div class="mb-4 flex justify-between items-center text-[10px] text-slate-500 font-mono border-b border-white/5 pb-2">
                            <span>MODE: <span class="${mode.color} font-bold">${mode.label.toUpperCase()}</span></span>
                            <span title="Berdasarkan Alokasi ${allocation*100}%">1 PTS  Rp ${Utils.formatCurrency(valPerPoint)}</span>
                        </div>`;
                    }

                    // --- REWARD FORM LOGIC ---
                    let rewardForm = '';
                    if (this.state.rewardStep === 0) {
                        rewardForm = `
                        <div class="flex gap-2">
                            <input id="rew-name" type="text" placeholder="Nama hadiah..." class="w-full bg-charcoal text-white rounded-lg px-4 py-3 text-sm border border-slate-700 focus:border-neonCyan outline-none">
                            <button onclick="App.controller.initReward()" class="bg-neonCyan hover:bg-white hover:text-obsidian text-obsidian px-5 rounded-lg font-bold transition-all shadow-lg"><i data-lucide="arrow-right" class="w-5 h-5"></i></button>
                        </div>`;
                    } else if (this.state.rewardStep === 1) {
                        rewardForm = `
                        <div class="text-center py-2 animate-[fadeIn_0.3s]">
                            <p class="text-white text-xs font-bold mb-3">Apakah hadiah ini memiliki harga nominal (Rp)?</p>
                            <div class="flex gap-3 justify-center">
                                <button onclick="App.controller.setRewardHasPrice(false)" class="px-4 py-2 rounded-lg border border-slate-600 text-slate-300 hover:bg-slate-700 text-xs">Tidak</button>
                                <button onclick="App.controller.setRewardHasPrice(true)" class="px-4 py-2 rounded-lg bg-neonPurple text-white hover:bg-neonPurple/80 shadow-lg text-xs font-bold">Ya, Ada</button>
                            </div>
                        </div>`;
                    } else if (this.state.rewardStep === 2) {
                        const showPriceInput = this.state.tempReward.hasPrice;
                        rewardForm = `
                        <div class="space-y-3 animate-[fadeIn_0.3s]">
                            <div class="flex items-center justify-between text-xs text-slate-400 px-1"><span>Item: <strong class="text-white">${this.state.tempReward.name}</strong></span><button onclick="App.controller.resetRewardForm()" class="text-neonRed hover:underline">Batal</button></div>
                            ${showPriceInput ? `<input id="rew-price" type="number" onkeyup="App.controller.calcRewardRecs()" placeholder="Masukkan Harga (Rp)..." class="w-full bg-charcoal text-white rounded-lg px-4 py-3 text-sm border border-slate-700 focus:border-neonPurple outline-none">` : ''}
                            
                            <!-- Dynamic Recs Container -->
                            <div id="rec-container"></div>

                            <div class="flex gap-2">
                                <input id="rew-cost" type="number" placeholder="Target Poin (Contoh: 50)" class="flex-1 bg-charcoal text-white rounded-lg px-4 py-3 text-sm border border-slate-700 focus:border-neonCyan outline-none">
                                <button onclick="App.controller.saveReward()" class="bg-neonCyan hover:bg-white hover:text-obsidian text-obsidian px-5 rounded-lg font-bold transition-all shadow-lg"><i data-lucide="check" class="w-5 h-5"></i></button>
                            </div>
                        </div>`;
                    }

                    main.innerHTML = `
                    <div class="space-y-6 animate-[fadeIn_0.4s_ease-out] pt-4">
                        <div class="glass-card p-8 rounded-2xl text-center relative overflow-hidden"><div class="absolute inset-0 bg-gradient-to-br from-neonCyan/10 to-transparent"></div><p class="text-neonCyan mb-2 text-[10px] uppercase tracking-[0.3em] font-bold relative z-10">SALDO POIN</p><p class="text-6xl font-black text-white drop-shadow-[0_0_20px_rgba(6,182,212,0.5)] font-mono relative z-10">${Utils.formatCurrency(mon)}</p></div>
                        
                        ${financeSection}

                        <div class="space-y-2"><h3 class="text-xs font-bold text-white uppercase tracking-widest pl-2 border-l-2 border-neonCyan">Target Baru</h3><div class="glass-card p-4 rounded-xl space-y-3">${rewardForm}</div></div>
                        <div class="space-y-3"><h3 class="text-xs font-bold text-white uppercase tracking-widest pl-2 border-l-2 border-neonPurple">Wishlist</h3>${active.length===0?'<div class="text-center py-8 text-xs text-slate-600 border border-dashed border-slate-800 rounded-xl">KOSONG</div>':active.map(r=>{const p=Math.min((mon/r.cost)*100,100); const col=mon>=r.cost?'bg-neonGreen':'bg-gradient-to-r from-neonCyan to-neonPurple'; return `
                        <div class="glass-card p-4 rounded-xl relative overflow-hidden group">
                            <div class="absolute bottom-0 left-0 h-1 ${col} transition-all duration-1000 shadow-[0_0_10px_currentColor]" style="width:${p}%"></div>
                            <div class="flex justify-between items-center relative z-10">
                                <div>
                                    <p class="text-white text-sm font-bold group-hover:text-neonCyan transition-colors">${r.name}</p>
                                    ${r.price ? `<p class="text-[10px] text-neonGold font-mono mb-0.5">Rp ${Utils.formatCurrency(r.price)}</p>` : ''}
                                    <p class="text-[10px] text-slate-400 mt-0.5 font-mono tracking-wide">Progress: ${Utils.formatCurrency(mon)} / <span class="text-white">${Utils.formatCurrency(r.cost)} PTS</span></p>
                                </div>
                                <button onclick="App.controller.delReward('${r.id}')" class="text-slate-600 hover:text-neonRed transition-colors p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>`}).join('')}</div>
                        <div class="pt-4 border-t border-white/5 space-y-3"><h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest pl-2 border-l-2 border-slate-600">Riwayat Klaim</h3>${redeemed.length===0?'<div class="text-center py-4 text-xs text-slate-700">Belum ada.</div>':redeemed.map(r=>`<div class="glass-card p-3 rounded-lg flex items-center justify-between opacity-70"><div><p class="text-white text-xs font-bold">${r.name}</p><p class="text-[9px] text-slate-500">${Utils.formatDate(r.redeemedDate)}</p></div><div class="text-neonGreen text-[10px] font-mono flex items-center gap-1"><i data-lucide="check-circle" class="w-3 h-3"></i> TUKAR</div></div>`).join('')}</div>
                    </div>`;
                }
                else if (this.state.view === 'history') {
                    const [hy, hm] = this.state.histMonth.split('-');
                    const dim = new Date(hy, hm, 0).getDate();
                    const fDay = new Date(hy, parseInt(hm)-1, 1).getDay();
                    const offset = fDay===0?6:fDay-1;
                    const days = Array.from({length:dim},(_,i)=>`${this.state.histMonth}-${String(i+1).padStart(2,'0')}`);
                    const sd = this.state.histDate;
                    const sTasks = sd ? tasks.filter(t=>t.date===sd) : [];
                    const sRef = sd ? reflections.find(r=>r.date===sd) : null;

                    let grid = '';
                    for(let i=0;i<offset;i++) grid+=`<div class="aspect-square"></div>`;
                    days.forEach(d => {
                        const dayTasks = tasks.filter(t=>t.date===d);
                        const has = dayTasks.length>0;
                        const all = has && dayTasks.every(t=>t.status==='completed');
                        const fail = dayTasks.some(t=>t.status==='failed');
                        let bg='bg-slate-800/30 text-slate-500', br='border-transparent';
                        if(has) { if(all){bg='bg-neonGreen/20 text-white';br='border-neonGreen/50'} else if(fail){bg='bg-neonRed/20 text-white';br='border-neonRed/50'} else {bg='bg-neonPurple/20 text-white';br='border-neonPurple/50'} }
                        if(sd===d) { bg='bg-neonCyan text-obsidian font-bold shadow-[0_0_10px_rgba(6,182,212,0.5)]'; br='border-white'; }
                        grid+=`<button onclick="App.controller.setDate('${d}')" class="cal-cell ${sd===d?'active':''} aspect-square rounded-lg flex items-center justify-center text-xs border ${br} ${bg} transition-all hover:scale-105 active:scale-95">${new Date(d).getDate()}</button>`;
                    });

                    main.innerHTML = `
                    <div class="pt-2 animate-[fadeIn_0.4s_ease-out] pb-24">
                        <div class="text-center mb-4">
                            <div class="inline-block px-4 py-1 rounded-full bg-slate-800/50 border border-slate-700 mb-2">
                                <p class="text-[10px] text-slate-400 uppercase tracking-widest">HARI INI</p>
                                <p class="text-neonCyan font-bold text-sm">${Utils.formatDate(today)}</p>
                            </div>
                            <div class="flex justify-center gap-2">
                                 <div class="px-3 py-1 rounded-lg bg-neonPurple/10 border border-neonPurple/30 flex items-center gap-2">
                                    <i data-lucide="trending-up" class="w-3 h-3 text-neonPurple"></i>
                                    <span class="text-[10px] text-neonPurple font-bold">AVG: ${pts.avg} PTS/HARI</span>
                                 </div>
                            </div>
                        </div>

                        <div class="flex items-center justify-between glass-card p-2 rounded-xl mb-4"><button onclick="App.controller.navMonth(-1)" class="p-2 hover:bg-white/10 rounded-lg text-slate-400"><i data-lucide="chevron-left" class="w-5 h-5"></i></button><span class="text-white font-black text-sm tracking-[0.2em]">${Utils.formatMonth(this.state.histMonth)}</span><button onclick="App.controller.navMonth(1)" class="p-2 hover:bg-white/10 rounded-lg text-slate-400"><i data-lucide="chevron-right" class="w-5 h-5"></i></button></div>
                        <div class="grid grid-cols-7 gap-1 text-center mb-2">${['SEN','SEL','RAB','KAM','JUM','SAB','MIN'].map(d=>`<div class="text-[8px] font-bold text-slate-500 tracking-wider">${d}</div>`).join('')}</div>
                        <div class="grid grid-cols-7 gap-1.5 mb-6">${grid}</div>
                        
                        <div class="space-y-4 border-t border-white/5 pt-4">
                            ${!sd ? `<div class="text-center text-slate-600 text-xs font-mono pt-10 flex flex-col items-center gap-2"><i data-lucide="calendar-search" class="w-8 h-8 opacity-50"></i>PILIH TANGGAL</div>` : 
                            `<div class="flex justify-between items-center mb-2"><h3 class="text-neonCyan font-bold text-lg">${Utils.formatDate(sd)}</h3><span class="text-[10px] bg-slate px-2 py-1 rounded text-slate-400 font-mono border border-slate-700">LOG</span></div>
                            <div class="glass-card p-4 rounded-xl mb-4 relative overflow-hidden"><div class="absolute top-0 right-0 p-3 opacity-10"><i data-lucide="brain-circuit" class="w-12 h-12 text-white"></i></div><div class="text-[9px] text-neonPurple font-bold uppercase mb-2 tracking-wider">Refleksi</div><p class="text-slate-300 text-sm italic relative z-10">"${sRef ? sRef.text : 'Tidak ada catatan.'}"</p></div>
                            <div class="space-y-0">${sTasks.length === 0 ? '<p class="text-center text-xs text-slate-600 py-8">Tidak ada misi.</p>' : sTasks.map(t => ComponentFactory.taskItem(t, false)).join('')}</div>`}
                        </div>
                    </div>`;
                }

                lucide.createIcons();
            }
        };

        const App = { controller: Controller };
        window.addEventListener('DOMContentLoaded', () => App.controller.init());

    </script>
</body>
</html>
