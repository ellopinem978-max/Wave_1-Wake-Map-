<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#020617">
    <meta name="description" content="Wake Map - The Ultimate Execution Protocol">
    
    <!-- PWA MANIFEST & SETTINGS -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Wake Map">
    
    <!-- Favicon & App Icon -->
    <link rel="icon" type="image/png" href="https://placehold.co/64x64/020617/06b6d4.png?text=WM">
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/020617/06b6d4.png?text=WM">
    
    <!-- Inline Manifest for PWA Installation -->
    <link rel="manifest" href='data:application/manifest+json;base64,eyJuYW1lIjoiV2FrZSBNYXAgLSBVbHRpbWF0ZSBBcmNoaXRlY3QiLCJzaG9ydF9uYW1lIjoiV2FrZU1hcCIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMDIwNjE3IiwidGhlbWVfY29sb3IiOiIjMDIwNjE3IiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vcGxhY2Vob2xkLmNvLzE5MngxOTIvMDIwNjE3LzA2YjZkNC5wbmc/dGV4dD1XTSIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9wbmcifSx7InNyYyI6Imh0dHBzOi8vcGxhY2Vob2xkLmNvLzUxMng1MTIvMDIwNjE3LzA2YjZkNC5wbmc/dGV4dD1XTSIsInNpemVzIjoiNTEyeDUxMiIsInR5cGUiOiJpbWFnZS9wbmcifV19'>

    <title>Wake Map - Ultimate Architect</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;700&family=Audiowide&display=swap" rel="stylesheet">
    
    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                        display: ['Audiowide', 'cursive'],
                    },
                    colors: {
                        obsidian: "#020617",
                        charcoal: "#0f172a",
                        surface: "#1e293b", 
                        iron: "#334155",
                        neonCyan: "#06b6d4",
                        neonPurple: "#8b5cf6",
                        neonGold: "#f59e0b",
                        neonRed: "#ef4444",
                        neonGreen: "#10b981",
                        glass: "rgba(15, 23, 42, 0.65)",
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulseGlow 3s infinite alternate',
                        'shimmer': 'shimmer 2.5s linear infinite',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-6px)' },
                        },
                        pulseGlow: {
                            '0%': { boxShadow: '0 0 5px currentColor' },
                            '100%': { boxShadow: '0 0 20px currentColor' }
                        },
                        shimmer: {
                            '0%': { backgroundPosition: '-200% 0' },
                            '100%': { backgroundPosition: '200% 0' },
                        },
                        glow: {
                            'from': { boxShadow: '0 0 10px -10px #f59e0b' },
                            'to': { boxShadow: '0 0 20px 5px #f59e0b' }
                        }
                    }
                }
            }
        }
    </script>

    <!-- CORE STYLESHEET -->
    <style>
        :root { --ease-expo: cubic-bezier(0.19, 1, 0.22, 1); }
        body { background-color: #020617; color: #e2e8f0; overflow: hidden; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        /* Glassmorphism System */
        .glass-card {
            background: rgba(15, 23, 42, 0.65);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
            transition: background 0.3s, border 0.3s, box-shadow 0.3s;
        }
        .glass-card:active { background: rgba(15, 23, 42, 0.85); }

        /* Button Interactions */
        .btn-action { position: relative; overflow: hidden; transition: all 0.3s var(--ease-expo); }
        .btn-action::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }
        .btn-action:hover::after { left: 100%; }
        .btn-action:active { transform: scale(0.96); }

        /* TIER VISUAL SYSTEM */
        .tier-f { color: #4B5563; filter: grayscale(1); }
        .tier-e { color: #6B7280; filter: none; }
        .tier-d { color: #7C5C3B; }
        .tier-c { color: #4B7F52; text-shadow: 0 1px 2px rgba(75,127,82,0.3); }
        .tier-b { color: #3B82F6; text-shadow: 0 0 8px rgba(59,130,246,0.4); }
        .tier-a { color: #2563EB; text-shadow: 0 0 12px rgba(37,99,235,0.6); }
        .tier-s { color: #7C3AED; text-shadow: 0 0 15px rgba(124,58,237,0.6); }
        .tier-ss { background: linear-gradient(to bottom, #9333EA, #D946EF); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 8px rgba(147,51,234,0.6)); }
        .tier-ex { background: linear-gradient(135deg, #FEF08A 20%, #FACC15 50%, #A16207 80%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 1px 2px rgba(234,179,8,0.5)); }
        .tier-mr { background: linear-gradient(45deg, #CA8A04 0%, #FDE047 50%, #CA8A04 100%); background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: shimmer 4s linear infinite; filter: drop-shadow(0 0 5px rgba(202,138,4,0.6)); }
        .tier-ur { color: #22D3EE; text-shadow: 0 0 5px #fff, 0 0 15px #22D3EE, 0 0 25px #0891B2; animation: glow-pulse 3s infinite; }
        .tier-exr { color: #DC2626; text-shadow: 0 0 10px #EF4444, 0 0 20px #7F1D1D; filter: contrast(1.2); }
        .tier-hs { background: linear-gradient(to right, #B91C1C, #F59E0B, #B91C1C); background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: shimmer 6s linear infinite; filter: drop-shadow(0 0 8px rgba(245,158,11,0.4)); }
        .tier-ps { color: #F9FAFB; text-shadow: 0 0 10px rgba(255,255,255,0.8), 0 0 30px rgba(255,255,255,0.4); }
        .tier-max { background: linear-gradient(to bottom, #FFFFFF 30%, #FDE68A 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 15px #FDE68A, 0 0 40px #F59E0B; position: relative; animation: float 4s ease-in-out infinite; }

        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        @keyframes glow-pulse { 0%, 100% { text-shadow: 0 0 5px currentColor; } 50% { text-shadow: 0 0 20px currentColor, 0 0 10px #fff; } }

        /* Navigation Dock */
        .nav-dock {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.4);
        }
        .nav-item { position: relative; color: #64748b; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .nav-item.active { color: #06b6d4; transform: translateY(-4px); }
        .nav-item.active .nav-icon { filter: drop-shadow(0 4px 8px rgba(6,182,212,0.4)); stroke-width: 2.5px; }
        .nav-indicator { width: 4px; height: 4px; background: #06b6d4; border-radius: 50%; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%) scale(0); transition: transform 0.3s; box-shadow: 0 0 8px #06b6d4; }
        .nav-item.active .nav-indicator { transform: translateX(-50%) scale(1); }

        /* Toast & Overlays */
        #toast-layer { position: fixed; top: 20px; left: 0; right: 0; pointer-events: none; z-index: 100; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .toast-msg { background: rgba(15,23,42,0.95); backdrop-filter: blur(8px); padding: 12px 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 30px rgba(0,0,0,0.5); transform: translateY(-20px); opacity: 0; animation: toastEnter 0.4s forwards; }
        @keyframes toastEnter { to { transform: translateY(0); opacity: 1; } }
        @keyframes toastExit { to { transform: translateY(-20px); opacity: 0; } }

        /* Calendar Grid */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .cal-cell { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-size: 10px; font-weight: bold; border: 1px solid transparent; transition: all 0.2s; position: relative; }
        .cal-cell.active { background: rgba(6,182,212,0.15); border-color: rgba(6,182,212,0.5); color: #fff; }
        .cal-cell:hover { background: rgba(255,255,255,0.05); }

        /* Particle Canvas */
        #particle-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; opacity: 0.3; }
        .ambient-layer { position: fixed; inset: 0; pointer-events: none; z-index: 0; background: radial-gradient(circle at 0% 0%, rgba(6,182,212,0.05) 0%, transparent 50%), radial-gradient(circle at 100% 100%, rgba(139,92,246,0.05) 0%, transparent 50%); }
    </style>
</head>
<body class="font-sans text-sm antialiased text-textMain">

    <!-- APP SHELL -->
    <div id="app-root" class="relative w-full max-w-md mx-auto h-screen flex flex-col bg-obsidian shadow-2xl border-x border-white/5 overflow-hidden">
        
        <!-- Background Systems -->
        <canvas id="particle-canvas"></canvas>
        <div class="ambient-layer"></div>

        <!-- 1. HEADER -->
        <header id="app-header" class="flex-none pt-10 pb-4 px-6 z-20 border-b border-white/5 bg-gradient-to-b from-obsidian via-obsidian/95 to-transparent backdrop-blur-sm">
             <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-black text-white tracking-tight flex items-center gap-2 font-display">
                        <span class="text-neonCyan drop-shadow-[0_0_10px_rgba(6,182,212,0.5)]">WAKE</span>MAP
                    </h1>
                    <div onclick="window.location.reload()" class="flex items-center gap-2 mt-1 cursor-pointer group select-none">
                        <span class="relative flex h-2 w-2">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-neonGreen opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-2 w-2 bg-neonGreen"></span>
                        </span>
                        <p id="header-status" class="text-neonCyan/70 text-[10px] font-mono tracking-[0.2em] group-hover:text-neonCyan group-active:text-white transition-colors">TAP TO RELOAD</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="App.controller.openSettings()" class="glass-card p-2 rounded-lg hover:border-neonCyan/50 transition-colors text-slate-400 hover:text-white">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                    </button>
                    <div class="glass-card px-4 py-2 rounded-lg group hover:border-neonCyan/30 transition-colors cursor-default">
                        <span id="header-month" class="text-[10px] font-bold text-white uppercase tracking-[0.15em] group-hover:text-neonCyan transition-colors">...</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- 2. MAIN VIEWPORT -->
        <main id="app-viewport" class="flex-1 overflow-y-auto overscroll-y-contain px-5 py-6 hide-scroll relative z-10 space-y-8 scroll-smooth">
            <!-- Injected by Router -->
        </main>

        <!-- 3. NAVIGATION -->
        <nav id="app-nav" class="flex-none h-24 px-6 pb-6 pt-2 z-30 bg-gradient-to-t from-obsidian via-obsidian/95 to-transparent pointer-events-none">
            <div id="nav-inner" class="glass-card w-full h-full rounded-2xl flex items-center justify-around px-2 shadow-2xl backdrop-blur-xl pointer-events-auto">
                <!-- Injected by NavComponent -->
            </div>
        </nav>

        <!-- 4. OVERLAYS -->
        <div id="toast-layer"></div>
        <div id="modal-layer" class="fixed inset-0 z-50 pointer-events-none flex items-end sm:items-center justify-center transition-all duration-300 opacity-0 invisible backdrop-blur-sm bg-black/60"></div>

    </div>

    <!-- 
        ========================================================================
        JAVASCRIPT ARCHITECTURE
        ========================================================================
    -->
    <script>
        /**
         * MODULE 1: CONFIGURATION & CONSTANTS
         */
        const Config = {
            APP_NAME: 'Wake Map',
            VERSION: '7.2.0-CODEX',
            STORAGE_PREFIX: 'wakemap_arch_',
            
            // Goal Categories
            GOAL_CATEGORIES: [
                { id: 'disiplin', label: 'Disiplin', color: 'text-neonCyan', border: 'border-neonCyan' },
                { id: 'finansial', label: 'Finansial', color: 'text-neonGold', border: 'border-neonGold' },
                { id: 'kesehatan', label: 'Kesehatan', color: 'text-neonGreen', border: 'border-neonGreen' },
                { id: 'skill', label: 'Skill', color: 'text-neonPurple', border: 'border-neonPurple' },
                { id: 'lainnya', label: 'Lainnya', color: 'text-slate-400', border: 'border-slate-500' }
            ],

            // Time Protocol
            TIME_SLOTS: [
                { id: 'halt', label: 'HALT', range: '00:00 - 02:00', start: 0, end: 2, desc: 'Deep Rest & Recovery' },
                { id: 'void', label: 'VOID', range: '02:00 - 04:00', start: 2, end: 4, desc: 'Subconscious Processing' },
                { id: 'boot', label: 'BOOT', range: '04:00 - 06:00', start: 4, end: 6, desc: 'System Initialization' },
                { id: 'prim', label: 'PRIM', range: '06:00 - 08:00', start: 6, end: 8, desc: 'Prime Mental State' },
                { id: 'core', label: 'CORE', range: '08:00 - 10:00', start: 8, end: 10, desc: 'Deep Focus Work' },
                { id: 'flow', label: 'FLOW', range: '10:00 - 12:00', start: 10, end: 12, desc: 'High Performance Flow' },
                { id: 'idle', label: 'IDLE', range: '12:00 - 14:00', start: 12, end: 14, desc: 'System Recharge' },
                { id: 'sync', label: 'SYNC', range: '14:00 - 16:00', start: 14, end: 16, desc: 'Strategic Alignment' },
                { id: 'exec', label: 'EXEC', range: '16:00 - 18:00', start: 16, end: 18, desc: 'Tactical Execution' },
                { id: 'wind', label: 'WIND', range: '18:00 - 20:00', start: 18, end: 20, desc: 'Evening Decompression' },
                { id: 'rest', label: 'REST', range: '20:00 - 22:00', start: 20, end: 22, desc: 'Recovery Mode' },
                { id: 'fade', label: 'FADE', range: '22:00 - 24:00', start: 22, end: 24, desc: 'System Shutdown' },
                { id: 'all',  label: 'ALL',  range: '00:00 - 24:00', start: 0, end: 24, desc: 'Full Day Cycle' }
            ],

            // Rank Definitions (CODEX PANGKAT)
            TIERS: [
                { id:0, code:'F', name:'Failing', class:'tier-f', barColor:'#4B5563' },
                { id:1, code:'E', name:'Elementary', class:'tier-e', barColor:'#6B7280' },
                { id:2, code:'D', name:'Developing', class:'tier-d', barColor:'#7C5C3B' },
                { id:3, code:'C', name:'Capable', class:'tier-c', barColor:'#4B7F52' },
                { id:4, code:'B', name:'Balanced', class:'tier-b', barColor:'#3B82F6' },
                { id:5, code:'A', name:'Advanced', class:'tier-a', barColor:'#2563EB' },
                { id:6, code:'S', name:'Superior', class:'tier-s', barColor:'#7C3AED' },
                { id:7, code:'SS', name:'Supremely Skilled', class:'tier-ss', barColor:'#9333EA' },
                { id:8, code:'EX', name:'Exceptional', class:'tier-ex', barColor:'#FACC15' },
                { id:9, code:'MR', name:'Master Rank', class:'tier-mr', barColor:'#EAB308' },
                { id:10, code:'UR', name:'Ultra Rare', class:'tier-ur', barColor:'#22D3EE' },
                { id:11, code:'EXR', name:'Extreme Rank', class:'tier-exr', barColor:'#DC2626' },
                { id:12, code:'HS', name:'High Spec', class:'tier-hs', barColor:'#F59E0B' },
                { id:13, code:'PS', name:'Peak State', class:'tier-ps', barColor:'#F8FAFB' },
                { id:14, code:'MAX', name:'Maximum', class:'tier-max', barColor:'#FDE68A' }
            ],

            // Difficulty Settings
            DIFFICULTY: {
                easy: { id: 'easy', label: 'Mudah', pts: 2, color: 'text-neonGreen', border: 'border-neonGreen', hex: '#10b981' },
                medium: { id: 'medium', label: 'Sedang', pts: 4, color: 'text-neonCyan', border: 'border-neonCyan', hex: '#06b6d4' },
                hard: { id: 'hard', label: 'Sulit', pts: 6, color: 'text-neonPurple', border: 'border-neonPurple', hex: '#8b5cf6' }
            },

            // Productivity Modes
            PRODUCTIVITY_MODES: [
                { id: 'hibernasi', label: 'Hibernasi', pts: 8, desc: 'Recovery Mode', icon: 'battery-charging', color: 'text-slate-400' },
                { id: 'inisiasi', label: 'Inisiasi', pts: 16, desc: 'Starter', icon: 'sprout', color: 'text-neonGreen' },
                { id: 'standar', label: 'Standar', pts: 24, desc: 'Balanced', icon: 'scale', color: 'text-neonCyan' },
                { id: 'akselerasi', label: 'Akselerasi', pts: 36, desc: 'High Perf', icon: 'zap', color: 'text-neonPurple' },
                { id: 'dominasi', label: 'Dominasi', pts: 50, desc: 'Elite', icon: 'flame', color: 'text-neonRed' },
                { id: 'god', label: 'God Tier', pts: 70, desc: 'Limitless', icon: 'crown', color: 'text-neonGold' }
            ],
            
            // Reusing Tiers for Achievements if needed, logic is dynamic now
            ACHIEVEMENT_TIERS: {
                common: { id: 'common', label: 'Iron', bg: 'bg-slate-700', border: 'border-slate-500', glow: 'none' }
            }
        };

        /**
         * MODULE 2: UTILITIES
         */
        class Utils {
            static generateId() { 
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }
            static getISO(d = new Date()) {
                const y = d.getFullYear();
                const m = String(d.getMonth()+1).padStart(2,'0');
                const day = String(d.getDate()).padStart(2,'0');
                return `${y}-${m}-${day}`;
            }
            static getTomorrow() { 
                const d = new Date(); d.setDate(d.getDate()+1); 
                return this.getISO(d); 
            }
            static getMonthKey(iso) {
                return iso.slice(0, 7);
            }
            static formatMonth(iso) { 
                const [y,m]=iso.split('-'); 
                return new Date(y,parseInt(m)-1).toLocaleDateString('id-ID',{month:'long',year:'numeric'}).toUpperCase(); 
            }
            static formatDate(iso) { 
                return new Date(iso).toLocaleDateString('id-ID',{weekday:'long',day:'numeric',month:'long',year:'numeric'}); 
            }
            static formatCurrency(n) { 
                return new Intl.NumberFormat('id-ID').format(n); 
            }
            static getCurrentSlot() {
                const h = new Date().getHours();
                return Config.TIME_SLOTS.find(s => s.id !== 'all' && h >= s.start && h < s.end) || Config.TIME_SLOTS[0];
            }
        }

        /**
         * MODULE 3: DATA SERVICES (MODEL)
         */
        class Store {
            static get(key) { 
                try { 
                    const data = localStorage.getItem(Config.STORAGE_PREFIX + key);
                    if (key === 'settings') return data ? JSON.parse(data) : { muted: false };
                    return data ? JSON.parse(data) : []; 
                } catch { return key === 'settings' ? { muted: false } : []; } 
            }
            static set(key, data) { 
                localStorage.setItem(Config.STORAGE_PREFIX + key, JSON.stringify(data)); 
            }
            static prune(years) {
                const now = new Date();
                now.setFullYear(now.getFullYear() - years);
                const limitDate = Utils.getISO(now);
                const limitMonth = limitDate.slice(0, 7);

                let tasks = this.get('tasks');
                const tCount = tasks.length;
                tasks = tasks.filter(t => t.date >= limitDate);
                if(tasks.length < tCount) this.set('tasks', tasks);

                let refs = this.get('reflections');
                const rCount = refs.length;
                refs = refs.filter(r => r.date >= limitDate);
                if(refs.length < rCount) this.set('reflections', refs);

                let fins = this.get('finance');
                const fCount = fins.length;
                fins = fins.filter(f => f.month >= limitMonth);
                if(fins.length < fCount) this.set('finance', fins);
            }
        }

        /**
         * MODULE 4: AUDIO SYSTEM
         */
        class SoundEngine {
            constructor() {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                const settings = Store.get('settings');
                this.muted = settings ? settings.muted : false;
            }

            setMuted(val) {
                this.muted = val;
                Store.set('settings', { muted: val });
            }

            play(type) {
                if (this.muted) return;
                if (this.ctx.state === 'suspended') this.ctx.resume();

                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);

                const now = this.ctx.currentTime;

                if (type === 'click') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(800, now);
                    osc.frequency.exponentialRampToValueAtTime(300, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    osc.start(now);
                    osc.stop(now + 0.1);
                } else if (type === 'success') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(440, now); 
                    osc.frequency.setValueAtTime(554, now + 0.1); 
                    osc.frequency.setValueAtTime(659, now + 0.2); 
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.4);
                    osc.start(now);
                    osc.stop(now + 0.4);
                } else if (type === 'error') {
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.linearRampToValueAtTime(50, now + 0.3);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc.start(now);
                    osc.stop(now + 0.3);
                } else if (type === 'nav') {
                      osc.type = 'sine';
                      osc.frequency.setValueAtTime(600, now);
                      gain.gain.setValueAtTime(0.05, now);
                      gain.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
                      osc.start(now);
                      osc.stop(now + 0.05);
                }
            }
        }

        /**
         * MODULE 5: GAME ENGINE (LOGIC)
         */
        class Engine {
            static sortTasks(tasks) {
                return tasks.sort((a, b) => {
                    const slotA = Config.TIME_SLOTS.find(s => s.id === a.timeSlot) || { start: 99 };
                    const slotB = Config.TIME_SLOTS.find(s => s.id === b.timeSlot) || { start: 99 };
                    return slotA.start - slotB.start;
                });
            }

            static calcPoints(tasks) {
                const dObj = new Date();
                const today = Utils.getISO(dObj);
                const monthKey = today.slice(0, 7);
                const d = new Date(); d.setMonth(d.getMonth() - 1);
                const prevMonthKey = Utils.getISO(d).slice(0,7);
                
                let cur = 0, mon = 0, last = 0;
                tasks.forEach(t => {
                    if (t.status === 'completed') {
                        const pts = Config.DIFFICULTY[t.difficulty]?.pts || 0;
                        if (t.date === today) cur += pts;
                        if (t.date.startsWith(monthKey)) mon += pts;
                        if (t.date.startsWith(prevMonthKey)) last += pts;
                    }
                });

                const dayNum = dObj.getDate();
                const avg = dayNum > 0 ? (mon / dayNum).toFixed(1) : '0.0';

                return { cur, mon, last, avg };
            }
            
            static calcRank(monthKey, tasks, financeData) {
                let eTier=0, eBar=0, cTier=0, cBar=0;
                const mTasks = tasks.filter(t => t.date.startsWith(monthKey));
                
                const config = financeData.find(f => f.month === monthKey);
                const dailyTarget = config ? config.targetPts : 10;

                const dates = [...new Set(mTasks.map(t => t.date))].sort();
                
                let eWins = 0;
                let cWins = 0;

                dates.forEach(d => {
                    const ts = mTasks.filter(t => t.date === d);
                    const done = ts.filter(t => t.status === 'completed').length;
                    const total = ts.length;
                    
                    const dayPoints = ts.reduce((acc, t) => acc + (t.status === 'completed' ? Config.DIFFICULTY[t.difficulty].pts : 0), 0);

                    if (done === total && total > 0) eWins++;
                    if (dayPoints >= dailyTarget) cWins++;
                });

                const maxTier = Config.TIERS.length - 1;

                let eTierIndex = Math.floor(eWins / 4);
                if (eTierIndex > maxTier) eTierIndex = maxTier;
                let eBars = Math.floor((eWins % 4) / 2);
                if (eTierIndex === maxTier) eBars = 2;

                let cTierIndex = Math.floor(cWins / 4);
                if (cTierIndex > maxTier) cTierIndex = maxTier;
                let cBars = Math.floor((cWins % 4) / 2);
                if (cTierIndex === maxTier) cBars = 2;

                return { 
                    exec: { tier: Config.TIERS[eTierIndex], bars: eBars }, 
                    cons: { tier: Config.TIERS[cTierIndex], bars: cBars },
                    dailyTarget: dailyTarget
                };
            }

            static checkAutoFail(tasks) {
                const now = new Date();
                const today = Utils.getISO(now);
                const h = now.getHours();
                let hasChange = false;

                tasks.forEach(task => {
                    if (task.status === 'pending') {
                        if (task.date < today) {
                            task.status = 'failed';
                            hasChange = true;
                        } 
                        else if (task.date === today) {
                            const slot = Config.TIME_SLOTS.find(s => s.id === (task.timeSlot||'all'));
                            if(slot && slot.id !== 'all' && h >= slot.end) {
                                task.status = 'failed';
                                hasChange = true;
                            }
                        }
                    }
                });
                return hasChange;
            }
        }

        /**
         * MODULE 6: VISUAL EFFECTS SYSTEM
         */
        class VFXEngine {
            constructor() {
                this.canvas = document.getElementById('particle-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.width = window.innerWidth;
                this.height = window.innerHeight;
                this.particles = [];
                this.init();
            }

            init() {
                this.resize();
                window.addEventListener('resize', () => this.resize());
                for(let i=0; i<40; i++) this.particles.push(this.createParticle());
                this.animate();
            }

            resize() {
                this.width = this.canvas.width = window.innerWidth;
                this.height = this.canvas.height = window.innerHeight;
            }

            createParticle() {
                return {
                    x: Math.random() * this.width,
                    y: Math.random() * this.height,
                    vx: (Math.random() - 0.5) * 0.3,
                    vy: (Math.random() - 0.5) * 0.3,
                    size: Math.random() * 2,
                    alpha: Math.random() * 0.5
                };
            }

            animate() {
                this.ctx.clearRect(0, 0, this.width, this.height);
                this.particles.forEach(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    if(p.x < 0) p.x = this.width;
                    if(p.x > this.width) p.x = 0;
                    if(p.y < 0) p.y = this.height;
                    if(p.y > this.height) p.y = 0;
                    
                    this.ctx.fillStyle = `rgba(6, 182, 212, ${p.alpha})`;
                    this.ctx.beginPath();
                    this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    this.ctx.fill();
                });
                requestAnimationFrame(() => this.animate());
            }
        }

        /**
         * MODULE 7: UI COMPONENT FACTORY
         */
        const ComponentFactory = {
            rankCard(title, data, icon) {
                const t = data.tier;
                const col = t.barColor;
                
                let bars = '';
                for(let i=1; i<=2; i++) {
                    const active = i <= data.bars;
                    const activeStyle = `background-color:${col}; box-shadow: 0 0 10px ${col}, 0 0 20px ${col}; border: 1px solid rgba(255,255,255,0.5);`;
                    const inactiveStyle = `background-color:#1e293b; border: 1px solid rgba(255,255,255,0.05); box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);`;
                    const style = active ? activeStyle : inactiveStyle;
                    
                    bars += `<div class="w-1/2 h-2 rounded-full transition-all duration-500" style="${style}"></div>`;
                }

                return `
                <div class="glass-card p-4 rounded-xl flex-1 flex flex-col items-center justify-between relative overflow-hidden group min-h-[120px] hover:bg-white/5 transition-colors cursor-default">
                    <div class="absolute inset-0 bg-gradient-to-b from-white/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    
                    <div class="flex items-center justify-between w-full mb-1 z-10">
                        <span class="text-[8px] font-mono text-slate-400 font-bold tracking-widest">${title}</span>
                        <i data-lucide="${icon}" class="w-3 h-3 text-slate-500"></i>
                    </div>

                    <div class="font-display text-4xl mb-1 z-10 transition-all duration-500" style="color:${col}; text-shadow: 0 0 15px ${col};">
                        ${t.code}
                    </div>

                    <div class="text-[8px] text-white font-bold tracking-[0.2em] z-10 mb-3 uppercase opacity-80">${t.name}</div>
                    
                    <div class="flex gap-2 w-full max-w-[60px] z-10">${bars}</div>
                </div>`;
            },

            analyticsCard(tasks) {
                const labels = [];
                const data = [];
                const today = new Date();
                
                for(let i=6; i>=0; i--) {
                    const d = new Date();
                    d.setDate(today.getDate() - i);
                    const iso = Utils.getISO(d);
                    const dayName = d.toLocaleDateString('id-ID', {weekday:'short'}).toUpperCase().slice(0,3);
                    labels.push(dayName);
                    
                    const dayTasks = tasks.filter(t => t.date === iso && t.status === 'completed');
                    const pts = dayTasks.reduce((acc, t) => acc + (Config.DIFFICULTY[t.difficulty]?.pts || 0), 0);
                    data.push(pts);
                }

                const maxVal = Math.max(...data, 10); 
                const h = 60; 
                const w = 100;
                const stepX = w / (data.length - 1);
                
                let points = "";
                data.forEach((val, i) => {
                    const x = i * stepX;
                    const y = h - ((val / maxVal) * h);
                    points += `${x},${y} `;
                });

                return `
                <div class="glass-card p-4 rounded-xl mb-4 relative overflow-hidden">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <div class="p-1.5 rounded bg-neonCyan/10"><i data-lucide="activity" class="w-3 h-3 text-neonCyan"></i></div>
                            <span class="text-[10px] font-bold uppercase tracking-widest text-slate-300">Neural Analytics</span>
                        </div>
                        <span class="text-[9px] text-slate-500 font-mono">7 HARI TERAKHIR</span>
                    </div>
                    
                    <div class="relative h-16 w-full mt-2">
                        <div class="absolute inset-0 flex flex-col justify-between opacity-10">
                            <div class="border-t border-white w-full"></div>
                            <div class="border-t border-white w-full"></div>
                            <div class="border-t border-white w-full"></div>
                        </div>
                        
                        <svg viewBox="0 0 100 60" preserveAspectRatio="none" class="w-full h-full overflow-visible">
                            <defs>
                                <linearGradient id="chartGrad" x1="0" x2="0" y1="0" y2="1">
                                    <stop offset="0%" stop-color="#06b6d4" stop-opacity="0.3"/>
                                    <stop offset="100%" stop-color="#06b6d4" stop-opacity="0"/>
                                </linearGradient>
                            </defs>
                            <polygon points="0,60 ${points} 100,60" fill="url(#chartGrad)" />
                            <polyline points="${points}" fill="none" stroke="#06b6d4" stroke-width="2" vector-effect="non-scaling-stroke" />
                            ${data.map((val, i) => {
                                const x = i * stepX;
                                const y = h - ((val / maxVal) * h);
                                return `<circle cx="${x}" cy="${y}" r="3" class="fill-obsidian stroke-neonCyan" stroke-width="1.5" vector-effect="non-scaling-stroke"/>`;
                            }).join('')}
                        </svg>
                    </div>
                    
                    <div class="flex justify-between mt-2 px-1">
                        ${labels.map(l => `<span class="text-[8px] font-mono text-slate-500">${l}</span>`).join('')}
                    </div>
                </div>`;
            },

            // UPDATED: Use Config.TIERS instead of static achievement tiers
            achievementBadge(ach) {
                const tier = Config.TIERS[ach.tierIndex] || Config.TIERS[0];
                const cat = Config.GOAL_CATEGORIES.find(c => c.id === ach.category) || {color:'text-white', label:''};
                
                return `
                <div class="glass-card flex flex-col items-center justify-center p-3 rounded-xl border border-white/10 relative overflow-hidden group hover:scale-105 transition-transform duration-300 shadow-[0_0_15px_rgba(0,0,0,0.3)] relative">
                    ${ach.isFinal ? `<div class="absolute top-1 right-1 text-neonGreen"><i data-lucide="check-circle-2" class="w-3 h-3"></i></div>` : ''}
                    <div class="p-2 rounded-full bg-black/30 mb-2 font-display text-xl" style="color: ${tier.barColor}; text-shadow: 0 0 10px ${tier.barColor}">
                        ${tier.code}
                    </div>
                    <span class="text-[9px] text-center font-bold text-white uppercase leading-tight">${ach.title}</span>
                    <span class="text-[8px] text-center text-white/60 font-mono mt-1">${Utils.formatDate(ach.dateUnlocked).split(',')[1]}</span>
                    <span class="text-[7px] uppercase mt-1 px-1.5 py-0.5 rounded bg-black/30 ${cat.color}">${cat.label}</span>
                    <button onclick="if(confirm('Hapus snapshot sejarah ini?')){App.controller.deleteAchievement('${ach.id}')}" class="absolute top-1 left-1 opacity-0 group-hover:opacity-100 text-slate-500 hover:text-neonRed transition-opacity"><i data-lucide="trash" class="w-3 h-3"></i></button>
                </div>`;
            },

            // NEW: Stack Component for Progressive Goals
            achievementStack(goalId, snapshots) {
                const latest = snapshots[snapshots.length - 1];
                const tier = Config.TIERS[latest.tierIndex] || Config.TIERS[0];
                const count = snapshots.length;
                const cat = Config.GOAL_CATEGORIES.find(c => c.id === latest.category) || {color:'text-white', label:''};

                return `
                <div onclick="App.controller.openStackDetails('${goalId}')" class="glass-card flex flex-col items-center justify-center p-3 rounded-xl border border-white/10 relative overflow-hidden group hover:scale-105 transition-transform duration-300 cursor-pointer shadow-[0_0_15px_rgba(0,0,0,0.3)]">
                    <div class="absolute top-[-5px] right-[-5px] w-6 h-6 flex items-center justify-center bg-neonCyan text-obsidian font-bold text-[8px] rounded-bl-lg z-10">${count}</div>
                    
                    ${latest.isFinal ? `<div class="absolute top-1 right-5 text-neonGreen"><i data-lucide="check-circle-2" class="w-3 h-3"></i></div>` : ''}
                    
                    <div class="p-2 rounded-full bg-black/30 mb-2 font-display text-xl" style="color: ${tier.barColor}; text-shadow: 0 0 10px ${tier.barColor}">
                        ${tier.code}
                    </div>
                    <span class="text-[9px] text-center font-bold text-white uppercase leading-tight line-clamp-2">${latest.title}</span>
                    <span class="text-[8px] text-center text-white/60 font-mono mt-1">Updated: ${Utils.formatDate(latest.dateUnlocked).split(',')[1]}</span>
                    <span class="text-[7px] uppercase mt-1 px-1.5 py-0.5 rounded bg-black/30 ${cat.color}">${cat.label}</span>
                    
                    <!-- Stack Visual Effect -->
                    <div class="absolute bottom-0 inset-x-2 h-1 bg-white/10 rounded-t-sm"></div>
                    <div class="absolute bottom-1 inset-x-3 h-1 bg-white/5 rounded-t-sm"></div>
                </div>`;
            },

            goalCard(goal) {
                const cat = Config.GOAL_CATEGORIES.find(c => c.id === goal.category) || {label:'Lainnya', color:'text-slate-400', border:'border-slate-500'};
                
                return `
                <div class="glass-card p-4 rounded-xl border ${cat.border} relative group min-w-[200px] flex flex-col justify-between">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <i data-lucide="target" class="w-4 h-4 ${cat.color}"></i>
                            <span class="text-[10px] font-bold uppercase tracking-widest ${cat.color}">${cat.label}</span>
                        </div>
                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="App.controller.editGoal('${goal.id}')" class="p-1 text-slate-400 hover:text-white"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                            <button onclick="App.controller.deleteGoal('${goal.id}')" class="p-1 text-slate-400 hover:text-neonRed"><i data-lucide="trash" class="w-3 h-3"></i></button>
                        </div>
                    </div>
                    
                    <h3 class="text-sm font-bold text-white mb-1">${goal.title}</h3>
                    <p class="text-xs text-slate-400 font-mono mb-4">
                        ${goal.type === 'progressive' ? `Target: <span class="text-white">${goal.currentTarget}</span>` : `<span class="text-neonGold font-bold">RANK ${Config.TIERS[goal.rankIndex].code}</span>`}
                    </p>
                    
                    <button onclick="App.controller.openSnapshotModal('${goal.id}')" class="w-full bg-slate-800 hover:bg-neonCyan hover:text-obsidian text-slate-300 text-[10px] font-bold py-2 rounded-lg transition-colors flex items-center justify-center gap-1 border border-slate-700">
                        <i data-lucide="camera" class="w-3 h-3"></i> CHECKPOINT
                    </button>
                </div>`;
            },

            taskItem(t, isToday) {
                const slot = Config.TIME_SLOTS.find(s=>s.id === (t.timeSlot||'all'));
                const diff = Config.DIFFICULTY[t.difficulty];
                
                let action = '';
                let cardClass = '';
                let textClass = 'text-white font-medium';

                if (t.status === 'completed') {
                    cardClass = 'bg-green-900/20 border-green-500/30 shadow-[0_0_10px_rgba(16,185,129,0.1)]';
                    action = `<i data-lucide="check-circle" class="text-neonGreen w-5 h-5 drop-shadow-md"></i>`;
                    textClass = 'text-neonGreen font-bold';
                } 
                else if (t.status === 'failed') {
                    cardClass = 'bg-red-900/20 border-red-500/30';
                    action = `<i data-lucide="x-circle" class="text-neonRed w-5 h-5 drop-shadow-md"></i>`;
                    textClass = 'text-neonRed font-bold';
                }
                else if (isToday && t.status === 'pending') {
                    cardClass = 'border-dashed border-slate-600 bg-transparent';
                    action = `
                    <div class="flex gap-2">
                        <button onclick="App.controller.updateTask('${t.id}','failed')" class="w-9 h-9 rounded-xl bg-slate-800 border border-neonRed/30 text-neonRed flex items-center justify-center hover:bg-neonRed/20 active:scale-95 transition-all"><i data-lucide="x" class="w-4 h-4"></i></button>
                        <button onclick="App.controller.updateTask('${t.id}','completed')" class="w-9 h-9 rounded-xl bg-slate-800 border border-neonGreen/30 text-neonGreen flex items-center justify-center hover:bg-neonGreen/20 active:scale-95 transition-all shadow-[0_0_10px_rgba(16,185,129,0.2)]"><i data-lucide="check" class="w-4 h-4"></i></button>
                    </div>`;
                } 
                else {
                    cardClass = 'glass-card opacity-90';
                    action = `<button onclick="App.controller.deleteTask('${t.id}')" class="text-slate-500 hover:text-neonRed p-2 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
                }

                return `
                <div class="p-4 rounded-xl flex items-center justify-between border mb-3 transition-all ${cardClass}">
                    <div class="flex-1 pr-3">
                        <div class="flex items-center gap-2 mb-1.5">
                            <span class="text-[8px] font-mono font-bold text-slate-300 bg-surface px-1.5 py-0.5 rounded border border-white/5">${slot.label}</span>
                            <span class="text-[8px] font-bold border px-1.5 py-0.5 rounded uppercase ${diff.color} ${diff.border} bg-white/5">${diff.label}</span>
                        </div>
                        <p class="text-sm ${textClass} leading-snug">${t.text}</p>
                    </div>
                    <div>${action}</div>
                </div>`;
            },

            rankLegend() {
                return Config.TIERS.slice().reverse().map(t => `
                <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-white/5 transition-colors border-b border-white/5 last:border-0">
                    <div class="font-display w-8 text-center text-lg ${t.class}">${t.code}</div>
                    <div class="flex-1">
                        <div class="text-[10px] font-bold text-white uppercase tracking-wider">${t.name}</div>
                    </div>
                </div>`).join('');
            }
        };

        /**
         * MODULE 8: MAIN CONTROLLER
         */
        const Controller = {
            state: {
                view: 'home',
                difficulty: 'easy',
                histMonth: Utils.getISO().slice(0, 7),
                histDate: null,
                tempTask: null,
                rewardStep: 0, 
                tempReward: { name: '', hasPrice: false, price: 0, cost: 0, recs: null },
                showIncomeInput: false,
                tempMode: null,
                tempIncome: '',
                tempAlloc: '',
                tempTaskInput: '',
                tempGoal: { id: null, title: '', target: '', category: 'lainnya', type: 'progressive', rankIndex: 0 },
                tempSnapshot: { goalId: null, milestone: '', isFinal: false, nextTarget: '', tierIndex: 0 },
                lastNotifTime: 0
            },

            init() {
                new VFXEngine();
                this.sound = new SoundEngine();
                
                Store.prune(2);
                
                const monthDisplay = document.getElementById('header-month');
                if (monthDisplay) {
                    monthDisplay.innerText = Utils.formatMonth(Utils.getMonthKey(Utils.getISO()));
                }

                this.render();

                setInterval(() => {
                    const tasks = Store.get('tasks');
                    let hasUpdate = false;

                    if (Engine.checkAutoFail(tasks)) {
                        Store.set('tasks', tasks);
                        this.sound.play('error'); 
                        this.toast('Status misi diperbarui!', 'error');
                        hasUpdate = true;
                    }

                    this.checkNotifications(tasks);

                    if(hasUpdate && this.state.view === 'home') this.render();
                }, 10000);
            },

            // --- NOTIFICATION SYSTEM ---
            requestPermission() {
                if (!("Notification" in window)) {
                    this.toast("Browser tidak mendukung notifikasi", "error");
                    return;
                }
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        this.toast("Notifikasi diaktifkan!", "success");
                        this.sound.play('success');
                        this.openSettings(); 
                        new Notification("Wake Map Active", { body: "Sistem notifikasi siap.", icon: "https://placehold.co/192x192/020617/06b6d4.png?text=WM" });
                    }
                });
            },

            checkNotifications(tasks) {
                if (!("Notification" in window) || Notification.permission !== "granted") return;

                const now = new Date();
                if (now.getTime() - this.state.lastNotifTime < 900000) return;

                const currentSlot = Utils.getCurrentSlot();
                const today = Utils.getISO();
                
                const activeTasks = tasks.filter(t => 
                    t.date === today && 
                    t.status === 'pending' && 
                    (t.timeSlot === currentSlot.id || t.timeSlot === 'all')
                );

                if (activeTasks.length > 0) {
                    const title = ` ${currentSlot.label} PHASE: ${activeTasks.length} Misi Aktif`;
                    const body = activeTasks.map(t => t.text).join(", ");
                    
                    const notif = new Notification(title, {
                        body: body,
                        icon: "https://placehold.co/192x192/020617/06b6d4.png?text=WM",
                        tag: "wakemap-alert",
                        vibrate: [200, 100, 200]
                    });

                    this.state.lastNotifTime = now.getTime();
                    setTimeout(() => notif.close(), 10000); 
                }
            },

            navigate(view) { 
                this.state.view = view; 
                this.sound.play('nav');
                this.render(); 
            },
            
            setDifficulty(d) { 
                const el = document.getElementById('task-in');
                if(el) this.state.tempTaskInput = el.value;

                this.state.difficulty = d; 
                this.sound.play('click');
                this.render(); 
            },

            // --- ACTIONS ---
            initTask() {
                const input = document.getElementById('task-in');
                const text = input.value.trim();
                if (!text) { 
                    this.toast('Nama misi wajib diisi', 'error'); 
                    return; 
                }
                this.state.tempTask = { text, difficulty: this.state.difficulty };
                this.state.tempTaskInput = ''; 
                this.openModal();
                input.value = '';
                this.sound.play('click');
            },

            confirmTask(slotId) {
                if (!this.state.tempTask) return;
                const tasks = Store.get('tasks');
                tasks.push({
                    id: Utils.generateId(),
                    text: this.state.tempTask.text,
                    difficulty: this.state.tempTask.difficulty,
                    timeSlot: slotId,
                    date: Utils.getTomorrow(), 
                    status: 'pending',
                    createdAt: new Date().toISOString()
                });
                Store.set('tasks', tasks);
                this.closeModal();
                this.sound.play('success');
                this.toast('Misi dijadwalkan besok', 'success');
                this.render();
            },

            updateTask(id, status) {
                const tasks = Store.get('tasks');
                const t = tasks.find(x => x.id === id);
                if (t) {
                    t.status = status;
                    Store.set('tasks', tasks);
                    
                    if (status === 'completed') {
                        this.sound.play('success');
                        const { mon } = Engine.calcPoints(tasks);
                        const rewards = Store.get('rewards');
                        rewards.forEach(r => {
                            if (r.status === 'active' && mon >= r.cost) {
                                setTimeout(() => {
                                    if(confirm(`Hadiah "${r.name}" tercapai! Klaim?`)) {
                                        r.status = 'redeemed';
                                        r.redeemedDate = Utils.getISO();
                                        Store.set('rewards', rewards);
                                        this.sound.play('success');
                                        this.toast(`Hadiah "${r.name}" diklaim!`, 'success');
                                        this.render();
                                    }
                                }, 500);
                            }
                        });
                    } else {
                        this.sound.play('error');
                    }
                    this.render();
                }
            },

            deleteTask(id) {
                if(confirm('Hapus misi ini?')) {
                    const tasks = Store.get('tasks').filter(t => t.id !== id);
                    Store.set('tasks', tasks);
                    this.sound.play('click');
                    this.toast('Misi dihapus', 'info');
                    this.render();
                } else {
                    this.render();
                }
            },

            saveRef() {
                const val = document.getElementById('ref-in').value.trim();
                if(val) {
                    const refs = Store.get('reflections');
                    const today = Utils.getISO();
                    const ex = refs.find(r => r.date === today);
                    if(ex) ex.text = val; else refs.push({ date: today, text: val });
                    Store.set('reflections', refs);
                    this.sound.play('success');
                    this.toast('Refleksi tersimpan', 'success');
                    this.render();
                }
            },

            // --- BLUEPRINT SYSTEM ---
            openBlueprintManager() {
                this.sound.play('click');
                const blueprints = Store.get('blueprints'); 
                
                const m = document.getElementById('modal-layer');
                m.innerHTML = `
                <div class="bg-charcoal border-t sm:border border-slate-700 rounded-t-3xl sm:rounded-2xl w-full max-w-sm p-6 shadow-2xl pointer-events-auto animate-[slideIn_0.3s_ease-out] max-h-[80vh] flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-white">Blueprint System</h3>
                            <p class="text-slate-400 text-xs font-mono">Template Misi Rutin</p>
                        </div>
                        <button onclick="App.controller.closeModal()" class="text-slate-500 hover:text-white bg-slate-800/50 p-2 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                    
                    <div class="overflow-y-auto custom-scroll flex-1 pr-1 mb-4 space-y-3">
                        ${blueprints.length === 0 ? '<div class="text-center py-8 text-xs text-slate-600 border border-dashed border-slate-800 rounded-xl">Belum ada blueprint.</div>' : 
                        blueprints.map(bp => {
                            const d = Config.DIFFICULTY[bp.difficulty];
                            const s = Config.TIME_SLOTS.find(slot => slot.id === bp.timeSlot) || {label:'ALL'};
                            return `
                            <div class="glass-card p-3 rounded-xl flex items-center justify-between group">
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-[8px] font-mono font-bold text-slate-300 bg-surface px-1.5 py-0.5 rounded border border-white/5">${s.label}</span>
                                        <span class="text-[8px] font-bold border px-1.5 py-0.5 rounded uppercase ${d.color} ${d.border} bg-white/5">${d.label}</span>
                                    </div>
                                    <p class="text-sm text-white font-medium">${bp.text}</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="App.controller.deleteBlueprint('${bp.id}')" class="p-2 rounded-lg bg-slate-800 text-slate-500 hover:text-neonRed"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    <button onclick="App.controller.useBlueprint('${bp.id}')" class="p-2 rounded-lg bg-neonCyan text-obsidian hover:bg-white font-bold shadow-lg"><i data-lucide="plus" class="w-4 h-4"></i></button>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>

                    <div class="pt-4 border-t border-slate-700">
                        <h4 class="text-xs font-bold text-white uppercase tracking-widest mb-3">Buat Baru</h4>
                        <div class="space-y-3">
                            <input id="bp-text" type="text" placeholder="Nama Rutinitas..." class="w-full bg-surface text-white rounded-lg px-4 py-2 text-sm border border-slate-700 focus:border-neonCyan outline-none">
                            <div class="flex gap-2">
                                <select id="bp-diff" class="bg-surface text-white rounded-lg px-3 py-2 text-xs border border-slate-700 outline-none flex-1">
                                    <option value="easy">Mudah</option>
                                    <option value="medium">Sedang</option>
                                    <option value="hard">Sulit</option>
                                </select>
                                <select id="bp-slot" class="bg-surface text-white rounded-lg px-3 py-2 text-xs border border-slate-700 outline-none flex-1">
                                    ${Config.TIME_SLOTS.map(s => `<option value="${s.id}">${s.label}</option>`).join('')}
                                </select>
                            </div>
                            <button onclick="App.controller.saveBlueprint()" class="w-full bg-slate-700 hover:bg-neonCyan hover:text-obsidian text-white py-2 rounded-lg text-xs font-bold uppercase tracking-widest transition-colors">Simpan Template</button>
                        </div>
                    </div>
                </div>`;
                m.classList.remove('opacity-0', 'invisible', 'pointer-events-none');
                lucide.createIcons();
            },

            saveBlueprint() {
                const text = document.getElementById('bp-text').value.trim();
                const diff = document.getElementById('bp-diff').value;
                const slot = document.getElementById('bp-slot').value;

                if(!text) { this.toast('Nama blueprint wajib diisi', 'error'); return; }

                const bps = Store.get('blueprints');
                bps.push({
                    id: Utils.generateId(),
                    text: text,
                    difficulty: diff,
                    timeSlot: slot
                });
                Store.set('blueprints', bps);
                this.sound.play('success');
                this.toast('Blueprint tersimpan', 'success');
                this.openBlueprintManager(); 
            },

            deleteBlueprint(id) {
                if(confirm('Hapus blueprint ini?')) {
                    const bps = Store.get('blueprints').filter(b => b.id !== id);
                    Store.set('blueprints', bps);
                    this.sound.play('click');
                    this.openBlueprintManager(); 
                }
            },

            useBlueprint(id) {
                const bps = Store.get('blueprints');
                const bp = bps.find(b => b.id === id);
                if(bp) {
                    const tasks = Store.get('tasks');
                    tasks.push({
                        id: Utils.generateId(),
                        text: bp.text,
                        difficulty: bp.difficulty,
                        timeSlot: bp.timeSlot,
                        date: Utils.getTomorrow(),
                        status: 'pending',
                        createdAt: new Date().toISOString()
                    });
                    Store.set('tasks', tasks);
                    this.sound.play('success');
                    this.toast('Misi ditambahkan untuk besok!', 'success');
                    this.closeModal();
                    this.render();
                }
            },

            // --- GOAL & SNAPSHOT SYSTEM (NEW HALL OF FAME) ---
            openGoalModal(goalId = null) {
                this.sound.play('click');
                const goals = Store.get('goals') || [];
                const goal = goalId ? goals.find(g => g.id === goalId) : null;
                
                // Set temp state
                this.state.tempGoal = goal ? { ...goal } : { id: null, title: '', target: '', category: 'lainnya', type: 'progressive', rankIndex: 0 };

                const m = document.getElementById('modal-layer');
                m.innerHTML = `
                <div class="bg-charcoal border-t sm:border border-slate-700 rounded-t-3xl sm:rounded-2xl w-full max-w-sm p-6 shadow-2xl pointer-events-auto animate-[slideIn_0.3s_ease-out]">
                    <button onclick="App.controller.closeModal()" class="absolute top-6 right-6 text-slate-500 hover:text-white bg-slate-800/50 p-2 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                    <div class="mb-6"><h3 class="text-xl font-bold text-white mb-1">${goalId ? 'Edit Target' : 'Target Baru'}</h3><p class="text-slate-400 text-xs font-mono">Tentukan fokus jangka panjangmu.</p></div>
                    
                    <div class="space-y-4">
                        <!-- Goal Type Selection -->
                        <div class="flex bg-surface p-1 rounded-lg border border-slate-700">
                            <label class="flex-1 text-center cursor-pointer">
                                <input type="radio" name="goalType" value="progressive" class="peer hidden" ${this.state.tempGoal.type !== 'single' ? 'checked' : ''} onchange="App.controller.toggleGoalType('progressive')">
                                <div class="py-2 text-[10px] font-bold text-slate-400 peer-checked:bg-slate-700 peer-checked:text-neonCyan rounded-md transition-all">BERJENJANG (Level Up)</div>
                            </label>
                            <label class="flex-1 text-center cursor-pointer">
                                <input type="radio" name="goalType" value="single" class="peer hidden" ${this.state.tempGoal.type === 'single' ? 'checked' : ''} onchange="App.controller.toggleGoalType('single')">
                                <div class="py-2 text-[10px] font-bold text-slate-400 peer-checked:bg-slate-700 peer-checked:text-neonGold rounded-md transition-all">SEKALI JADI (One-Shot)</div>
                            </label>
                        </div>

                        <div>
                            <label class="text-[9px] text-slate-500 uppercase font-bold mb-1 block">Nama Target</label>
                            <input id="goal-title" type="text" value="${this.state.tempGoal.title}" placeholder="Misal: Berhenti Main Game" class="w-full bg-surface text-white rounded-lg px-4 py-2.5 text-sm border border-slate-700 focus:border-neonCyan outline-none">
                        </div>
                        
                        <div id="target-input-container" style="${this.state.tempGoal.type === 'single' ? 'display:none' : ''}">
                            <label class="text-[9px] text-slate-500 uppercase font-bold mb-1 block">Target Awal</label>
                            <input id="goal-target" type="text" value="${this.state.tempGoal.target}" placeholder="Misal: 3 Hari / Semester 1" class="w-full bg-surface text-white rounded-lg px-4 py-2.5 text-sm border border-slate-700 focus:border-neonCyan outline-none">
                        </div>

                        <div id="rank-input-container" style="${this.state.tempGoal.type !== 'single' ? 'display:none' : ''}">
                            <label class="text-[9px] text-slate-500 uppercase font-bold mb-1 block">Pilih Codex Pangkat (Difficulty)</label>
                            <select id="goal-rank" class="w-full bg-surface text-white rounded-lg px-4 py-2.5 text-sm border border-slate-700 focus:border-neonGold outline-none font-mono">
                                ${Config.TIERS.map((t, idx) => `<option value="${idx}" ${this.state.tempGoal.rankIndex === idx ? 'selected' : ''}>${t.code} - ${t.name}</option>`).join('')}
                            </select>
                        </div>

                        <div>
                            <label class="text-[9px] text-slate-500 uppercase font-bold mb-1 block">Kategori</label>
                            <select id="goal-cat" class="w-full bg-surface text-white rounded-lg px-4 py-2.5 text-sm border border-slate-700 focus:border-neonCyan outline-none">
                                ${Config.GOAL_CATEGORIES.map(c => `<option value="${c.id}" ${this.state.tempGoal.category === c.id ? 'selected' : ''}>${c.label}</option>`).join('')}
                            </select>
                        </div>
                        <button onclick="App.controller.saveGoal()" class="w-full bg-neonCyan text-obsidian px-4 py-3 rounded-lg font-bold hover:bg-white transition-colors shadow-lg flex justify-center items-center gap-2"><i data-lucide="save" class="w-4 h-4"></i> Simpan Target</button>
                    </div>
                </div>`;
                m.classList.remove('opacity-0', 'invisible', 'pointer-events-none');
                lucide.createIcons();
            },

            toggleGoalType(type) {
                const targetContainer = document.getElementById('target-input-container');
                const rankContainer = document.getElementById('rank-input-container');
                if (type === 'single') {
                    targetContainer.style.display = 'none';
                    rankContainer.style.display = 'block';
                } else {
                    targetContainer.style.display = 'block';
                    rankContainer.style.display = 'none';
                }
            },

            saveGoal() {
                const title = document.getElementById('goal-title').value.trim();
                const type = document.querySelector('input[name="goalType"]:checked').value;
                // For single type, Title IS the target. For progressive, we need a separate initial target.
                const target = type === 'progressive' ? document.getElementById('goal-target').value.trim() : title;
                const cat = document.getElementById('goal-cat').value;
                const rankIndex = type === 'single' ? parseInt(document.getElementById('goal-rank').value) : 0;

                if(!title || (type === 'progressive' && !target)) { this.toast('Semua data wajib diisi', 'error'); return; }

                let goals = Store.get('goals') || [];
                
                if (this.state.tempGoal.id) {
                    const idx = goals.findIndex(g => g.id === this.state.tempGoal.id);
                    if (idx !== -1) {
                        goals[idx] = { ...goals[idx], title, currentTarget: target, category: cat, type, rankIndex };
                    }
                } else {
                    goals.push({
                        id: Utils.generateId(),
                        title: title,
                        currentTarget: target,
                        category: cat,
                        type: type,
                        rankIndex: rankIndex,
                        status: 'active',
                        createdAt: Utils.getISO()
                    });
                }
                
                Store.set('goals', goals);
                this.sound.play('success');
                this.toast('Target Aktif tersimpan!', 'success');
                this.closeModal();
                this.render();
            },

            deleteGoal(id) {
                if(confirm('Hapus target ini? (Snapshot di Hall of Fame tidak akan hilang)')) {
                    const goals = Store.get('goals') || [];
                    const newGoals = goals.filter(g => g.id !== id);
                    Store.set('goals', newGoals);
                    this.sound.play('click');
                    this.render();
                }
            },

            openSnapshotModal(goalId) {
                this.sound.play('click');
                const goals = Store.get('goals') || [];
                const goal = goals.find(g => g.id === goalId);
                if (!goal) return;

                const goalType = goal.type || 'progressive'; 

                // Auto Calc Tier for Progressive based on count
                let calculatedTierIndex = 0; // Default F
                if (goalType === 'progressive') {
                    const achs = Store.get('achievements').filter(a => a.goalId === goalId);
                    const count = achs.length;
                    calculatedTierIndex = Math.min(count, Config.TIERS.length - 1);
                } else {
                    calculatedTierIndex = goal.rankIndex || 0;
                }

                this.state.tempSnapshot = { goalId: goal.id, milestone: goal.currentTarget, isFinal: false, nextTarget: '', tierIndex: calculatedTierIndex };

                const m = document.getElementById('modal-layer');
                let modalContent = '';

                // Show Locked Rank Badge
                const tierInfo = Config.TIERS[calculatedTierIndex];

                if (goalType === 'progressive') {
                    // PROGRESSIVE UI: Continue or Finalize
                    modalContent = `
                    <div class="mb-4 text-center">
                        <div class="font-display text-4xl mb-1 transition-all duration-500" style="color:${tierInfo.barColor}; text-shadow: 0 0 15px ${tierInfo.barColor};">
                            ${tierInfo.code}
                        </div>
                        <div class="text-[10px] text-white font-bold tracking-[0.2em] uppercase opacity-80">${tierInfo.name}</div>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="text-[9px] text-slate-500 uppercase font-bold mb-1 block flex justify-between">
                                <span>Pencapaian Saat Ini (Locked)</span>
                                <i data-lucide="lock" class="w-3 h-3 text-slate-500"></i>
                            </label>
                            <input type="text" value="${goal.currentTarget}" disabled class="w-full bg-slate-900 text-neonCyan font-bold rounded-lg px-4 py-3 text-sm border border-slate-800 cursor-not-allowed">
                        </div>

                        <div>
                            <label class="text-[9px] text-slate-500 uppercase font-bold mb-1 block">Target Berikutnya (Untuk Lanjut)</label>
                            <input id="snap-next" type="text" placeholder="Misal: Semester 2..." class="w-full bg-surface text-white rounded-lg px-4 py-3 text-sm border border-slate-700 focus:border-neonCyan outline-none">
                        </div>

                        <div class="grid grid-cols-2 gap-3 pt-2">
                            <button onclick="App.controller.saveSnapshot('final')" class="p-3 rounded-xl border border-neonRed/30 bg-neonRed/10 text-neonRed hover:bg-neonRed hover:text-white transition-all flex flex-col items-center justify-center gap-1 group">
                                <i data-lucide="flag" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                                <span class="text-[10px] font-bold">TAMAT / FINAL</span>
                            </button>
                            <button onclick="App.controller.saveSnapshot('continue')" class="p-3 rounded-xl bg-neonCyan text-obsidian hover:bg-white transition-all flex flex-col items-center justify-center gap-1 shadow-lg font-bold group">
                                <i data-lucide="arrow-up-circle" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                                <span class="text-[10px]">SIMPAN & LANJUT</span>
                            </button>
                        </div>
                    </div>`;
                } else {
                    // SINGLE UI: Just confirmation
                    modalContent = `
                    <div class="mb-6 text-center">
                        <div class="font-display text-6xl mb-2 transition-all duration-500" style="color:${tierInfo.barColor}; text-shadow: 0 0 20px ${tierInfo.barColor};">
                            ${tierInfo.code}
                        </div>
                        <div class="text-xs text-white font-bold tracking-[0.3em] uppercase opacity-80 mb-4">${tierInfo.name}</div>
                        <p class="text-slate-400 text-xs px-4">Anda akan menyimpan "<strong>${goal.title}</strong>" ke Hall of Fame sebagai pencapaian Rank ${tierInfo.code}.</p>
                    </div>
                    <button onclick="App.controller.saveSnapshot('final')" class="w-full bg-neonGold text-obsidian px-4 py-4 rounded-xl font-bold hover:bg-white transition-colors shadow-[0_0_20px_rgba(245,158,11,0.3)] flex justify-center items-center gap-2 tracking-widest">
                        <i data-lucide="trophy" class="w-5 h-5"></i> KLAIM KEJAYAAN
                    </button>`;
                }

                m.innerHTML = `
                <div class="bg-charcoal border-t sm:border border-slate-700 rounded-t-3xl sm:rounded-2xl w-full max-w-sm p-6 shadow-2xl pointer-events-auto animate-[slideIn_0.3s_ease-out]">
                    <button onclick="App.controller.closeModal()" class="absolute top-6 right-6 text-slate-500 hover:text-white bg-slate-800/50 p-2 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                    <div class="mb-4"><h3 class="text-xl font-bold text-white mb-1">Checkpoint Protocol</h3></div>
                    ${modalContent}
                </div>`;
                m.classList.remove('opacity-0', 'invisible', 'pointer-events-none');
                lucide.createIcons();
            },

            saveSnapshot(action) {
                const goalId = this.state.tempSnapshot.goalId;
                
                // 1. Get Goal & Validate
                let goals = Store.get('goals') || [];
                const goalIndex = goals.findIndex(g => g.id === goalId);
                if (goalIndex === -1) return;
                const goal = goals[goalIndex];
                const milestone = goal.currentTarget; 

                const goalType = goal.type || 'progressive';
                let nextTarget = '';
                
                // Logic Check
                if (goalType === 'progressive' && action === 'continue') {
                    nextTarget = document.getElementById('snap-next').value.trim();
                    if (!nextTarget) {
                        this.toast('Target selanjutnya wajib diisi untuk lanjut!', 'error');
                        return;
                    }
                }

                // 2. Prevent Duplicate
                let achs = Store.get('achievements');
                const isDuplicate = achs.some(a => a.goalId === goalId && a.title === milestone); // Exact title match for milestones
                if (isDuplicate) {
                    this.toast('Checkpoint ini sudah ada!', 'error');
                    return;
                }

                // 3. Save Achievement
                const isFinal = (action === 'final');
                // Use tempSnapshot tierIndex which was calculated in openSnapshotModal
                const tierIdx = this.state.tempSnapshot.tierIndex;

                achs.push({
                    id: Utils.generateId(),
                    title: milestone, // Just the milestone text (e.g. "Semester 1") or Title for Single
                    parentTitle: goal.title, // Keep parent title ref
                    tierIndex: tierIdx, 
                    category: goal.category,
                    dateUnlocked: Utils.getISO(),
                    isFinal: isFinal,
                    goalId: goalId
                });
                Store.set('achievements', achs);

                // 4. Update Goal State
                if (isFinal) {
                    // Remove from Active Goals if final
                    goals = goals.filter(g => g.id !== goalId);
                } else if (nextTarget) {
                    goals[goalIndex].currentTarget = nextTarget;
                }

                Store.set('goals', goals);

                this.sound.play('success');
                this.toast(isFinal ? 'Legenda telah diabadikan!' : 'Level Up! Target diperbarui.', 'success');
                this.closeModal();
                this.render();
            },

            deleteAchievement(id) {
                const achs = Store.get('achievements').filter(a => a.id !== id);
                Store.set('achievements', achs);
                this.sound.play('click');
                this.toast('Snapshot dihapus', 'info');
                this.closeModal(); // In case stack modal is open
                this.render();
            },

            // New: Show Stack Details
            openStackDetails(goalId) {
                this.sound.play('click');
                const achs = Store.get('achievements').filter(a => a.goalId === goalId);
                // Sort newest first
                achs.sort((a,b) => new Date(b.dateUnlocked) - new Date(a.dateUnlocked));
                
                if (achs.length === 0) return;
                const parentTitle = achs[0].parentTitle || "Pencapaian";

                const m = document.getElementById('modal-layer');
                m.innerHTML = `
                <div class="bg-charcoal border-t sm:border border-slate-700 rounded-t-3xl sm:rounded-2xl w-full max-w-sm p-6 shadow-2xl pointer-events-auto animate-[slideIn_0.3s_ease-out] max-h-[80vh] flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-lg font-bold text-white">${parentTitle}</h3>
                            <p class="text-slate-400 text-xs font-mono">Riwayat Perjalanan</p>
                        </div>
                        <button onclick="App.controller.closeModal()" class="text-slate-500 hover:text-white bg-slate-800/50 p-2 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                    
                    <div class="overflow-y-auto custom-scroll flex-1 pr-1 space-y-3">
                        ${achs.map(ach => {
                            const tier = Config.TIERS[ach.tierIndex] || Config.TIERS[0];
                            return `
                            <div class="glass-card p-3 rounded-xl flex items-center justify-between border border-white/5">
                                <div class="flex items-center gap-3">
                                    <div class="font-display text-2xl w-10 text-center" style="color:${tier.barColor}; text-shadow:0 0 10px ${tier.barColor}">${tier.code}</div>
                                    <div>
                                        <div class="text-sm font-bold text-white">${ach.title}</div>
                                        <div class="text-[10px] text-slate-500 font-mono">${Utils.formatDate(ach.dateUnlocked)}</div>
                                    </div>
                                </div>
                                <button onclick="if(confirm('Hapus entry ini?')){App.controller.deleteAchievement('${ach.id}')}" class="text-slate-600 hover:text-neonRed p-2"><i data-lucide="trash" class="w-4 h-4"></i></button>
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;
                m.classList.remove('opacity-0', 'invisible', 'pointer-events-none');
                lucide.createIcons();
            },

            // --- FINANCE & REWARD ACTIONS ---
            selectMode(id) {
                const incEl = document.getElementById('income-in');
                const allocEl = document.getElementById('alloc-in');
                
                if(incEl) this.state.tempIncome = incEl.value;
                if(allocEl) this.state.tempAlloc = allocEl.value;

                this.state.tempMode = id;
                this.sound.play('click');
                this.render();
            },

            saveMonthlyConfig() {
                const incomeIn = document.getElementById('income-in').value;
                const allocIn = document.getElementById('alloc-in').value;
                const modeId = this.state.tempMode;
                
                if(!incomeIn || incomeIn <= 0) { this.toast('Nominal gaji tidak valid', 'error'); return; }
                if(!modeId) { this.toast('Pilih mode operasi', 'error'); return; }
                
                const allocation = allocIn ? parseFloat(allocIn) : 0.2;

                const mode = Config.PRODUCTIVITY_MODES.find(m => m.id === modeId);
                const finance = Store.get('finance'); 
                const monthKey = Utils.getMonthKey(Utils.getISO());
                const newFinance = finance.filter(f => f.month !== monthKey);
                newFinance.push({ 
                    month: monthKey, 
                    amount: parseInt(incomeIn), 
                    targetPts: mode.pts, 
                    modeId: modeId,
                    allocation: allocation 
                });
                
                Store.set('finance', newFinance);
                this.state.tempIncome = ''; 
                this.state.tempAlloc = '';
                this.state.tempMode = null;
                
                this.sound.play('success');
                this.toast(`Protokol: ${mode.label.toUpperCase()} diaktifkan!`, 'success');
                this.render();
            },

            initReward() {
                const nameIn = document.getElementById('rew-name').value.trim();
                if(!nameIn) { this.toast('Nama hadiah wajib diisi', 'error'); return; }
                
                this.state.tempReward = { name: nameIn, hasPrice: false, price: 0, cost: 0, recs: null };
                this.state.rewardStep = 1;
                this.sound.play('click');
                this.render();
            },

            setRewardHasPrice(hasPrice) {
                this.state.tempReward.hasPrice = hasPrice;
                this.state.rewardStep = 2;
                this.sound.play('click');
                this.render();
            },

            calcRewardRecs() {
                const priceIn = document.getElementById('rew-price').value;
                if (!priceIn || priceIn <= 0) {
                    this.state.tempReward.recs = null;
                    const c = document.getElementById('rec-container');
                    if(c) c.innerHTML = '';
                    return;
                }

                const financeData = Store.get('finance');
                const curMonthKey = Utils.getMonthKey(Utils.getISO());
                const myFinance = financeData.find(f => f.month === curMonthKey);

                if (myFinance) {
                    const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
                    
                    const allocation = myFinance.allocation || 0.2; 
                    const monthlyBudget = myFinance.amount * allocation;
                    const dailyBudget = monthlyBudget / daysInMonth;
                    
                    const dailyTarget = myFinance.targetPts || 10;
                    
                    const valPerPoint = Math.max(1, Math.round(dailyBudget / dailyTarget)); 
                    const price = parseInt(priceIn);
                    
                    const normalPts = Math.ceil(price / valPerPoint);
                    const hardPts = Math.ceil(normalPts * 1.5);

                    const recContainer = document.getElementById('rec-container');
                    if (recContainer) {
                        recContainer.innerHTML = `
                        <div class="flex gap-2 mt-2 animate-[fadeIn_0.3s]">
                            <button onclick="App.controller.applyRec(${normalPts})" class="flex-1 bg-surface border border-slate-600 hover:border-neonCyan p-2 rounded-lg text-center transition-all group active:scale-95">
                                <span class="block text-[9px] text-slate-400 uppercase group-hover:text-white">Normal (Fair)</span>
                                <span class="block text-neonCyan font-bold font-mono text-sm">${normalPts} Pts</span>
                            </button>
                            <button onclick="App.controller.applyRec(${hardPts})" class="flex-1 bg-surface border border-slate-600 hover:border-neonPurple p-2 rounded-lg text-center transition-all group active:scale-95">
                                <span class="block text-[9px] text-slate-400 uppercase group-hover:text-white">Sulit (Hemat)</span>
                                <span class="block text-neonPurple font-bold font-mono text-sm">${hardPts} Pts</span>
                            </button>
                        </div>`;
                    }
                } else {
                      const recContainer = document.getElementById('rec-container');
                      if(recContainer) recContainer.innerHTML = `<p class="text-[10px] text-neonRed text-center mt-2">Belum ada data keuangan bulan ini. Cek Menu PETA.</p>`;
                }
            },

            applyRec(pts) {
                const costInput = document.getElementById('rew-cost');
                if (costInput) costInput.value = pts;
                this.sound.play('click'); 
            },

            resetRewardForm() {
                this.state.rewardStep = 0;
                this.state.tempReward = { name: '', hasPrice: false, price: 0, cost: 0, recs: null };
                this.sound.play('click');
                this.render();
            },

            saveReward() {
                const costIn = document.getElementById('rew-cost').value;
                if(!costIn || costIn <= 0) { this.toast('Target poin wajib diisi', 'error'); return; }
                
                let priceVal = 0;
                if(this.state.tempReward.hasPrice) {
                    const priceIn = document.getElementById('rew-price').value;
                    if(!priceIn || priceIn <= 0) { this.toast('Harga nominal wajib diisi', 'error'); return; }
                    priceVal = parseInt(priceIn);
                }

                const r = Store.get('rewards');
                r.push({
                    id: Utils.generateId(),
                    name: this.state.tempReward.name,
                    cost: parseInt(costIn),
                    price: priceVal,
                    status: 'active',
                    redeemedDate: null
                });
                Store.set('rewards', r);
                this.sound.play('success');
                this.toast('Target ditambahkan', 'success');
                this.resetRewardForm();
            },

            delReward(id) {
                if(confirm('Hapus target?')) {
                    const r = Store.get('rewards').filter(x => x.id !== id);
                    Store.set('rewards', r);
                    this.sound.play('click');
                    this.render();
                }
            },

            navMonth(offset) {
                const [y, m] = this.state.histMonth.split('-');
                const targetDate = new Date(y, parseInt(m) - 1 + offset);
                
                const now = new Date();
                const limitDate = new Date(now.getFullYear() - 2, now.getMonth(), 1);
                
                if (targetDate < limitDate) {
                    this.toast('Batas riwayat 2 tahun tercapai', 'info');
                    this.sound.play('error');
                    return;
                }

                this.state.histMonth = Utils.getISO(targetDate).slice(0, 7);
                this.state.histDate = null;
                this.sound.play('click');
                this.render();
            },

            setDate(d) {
                this.state.histDate = d;
                this.sound.play('click');
                this.render();
            },

            // --- SETTINGS ---
            openSettings() {
                this.sound.play('click');
                const m = document.getElementById('modal-layer');
                const isMuted = this.sound.muted;
                const notifPerm = ("Notification" in window) ? Notification.permission : 'denied';
                
                m.innerHTML = `
                <div class="bg-charcoal border-t sm:border border-slate-700 rounded-t-3xl sm:rounded-2xl w-full max-w-sm p-6 shadow-2xl pointer-events-auto animate-[slideIn_0.3s_ease-out]">
                    <button onclick="App.controller.closeModal()" class="absolute top-6 right-6 text-slate-500 hover:text-white bg-slate-800/50 p-2 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                    <div class="mb-6"><h3 class="text-xl font-bold text-white mb-1">Pengaturan</h3><p class="text-slate-400 text-xs font-mono">Konfigurasi sistem.</p></div>
                    <div class="space-y-3">
                        
                        <!-- Sound Toggle -->
                        <div class="flex items-center justify-between p-4 rounded-xl bg-surface border border-slate-700">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-neonPurple/10 rounded-lg text-neonPurple"><i data-lucide="${isMuted ? 'volume-x' : 'volume-2'}" class="w-5 h-5"></i></div>
                                <div>
                                    <span class="block text-sm font-bold text-white">Suara Efek (SFX)</span>
                                    <span class="block text-[10px] text-slate-400">${isMuted ? 'Nonaktif' : 'Aktif'}</span>
                                </div>
                            </div>
                            <button onclick="App.controller.toggleSound()" class="w-12 h-6 rounded-full transition-colors relative ${isMuted ? 'bg-slate-600' : 'bg-neonGreen'}">
                                <div class="absolute top-1 w-4 h-4 rounded-full bg-white transition-all ${isMuted ? 'left-1' : 'left-7'}"></div>
                            </button>
                        </div>

                        <!-- Notification Toggle -->
                        <div class="flex items-center justify-between p-4 rounded-xl bg-surface border border-slate-700">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-neonGold/10 rounded-lg text-neonGold"><i data-lucide="bell" class="w-5 h-5"></i></div>
                                <div>
                                    <span class="block text-sm font-bold text-white">Notifikasi Misi</span>
                                    <span class="block text-[10px] text-slate-400">${notifPerm === 'granted' ? 'Aktif (System)' : 'Nonaktif'}</span>
                                </div>
                            </div>
                            ${notifPerm === 'granted' 
                                ? `<span class="text-[10px] text-neonGreen font-bold px-2">ON</span>` 
                                : `<button onclick="App.controller.requestPermission()" class="px-3 py-1.5 rounded-lg bg-slate-700 text-white text-[10px] hover:bg-neonGold hover:text-obsidian transition-colors">Aktifkan</button>`
                            }
                        </div>

                        <button onclick="App.controller.exportData()" class="w-full flex items-center gap-3 p-4 rounded-xl bg-surface border border-slate-700 hover:border-neonCyan transition-all group">
                            <div class="p-2 bg-neonCyan/10 rounded-lg text-neonCyan"><i data-lucide="download" class="w-5 h-5"></i></div>
                            <div class="text-left">
                                <span class="block text-sm font-bold text-white group-hover:text-neonCyan transition-colors">Backup Data</span>
                                <span class="block text-[10px] text-slate-400">Unduh data ke file JSON</span>
                            </div>
                        </button>
                        
                        <button onclick="App.controller.importData()" class="w-full flex items-center gap-3 p-4 rounded-xl bg-surface border border-slate-700 hover:border-neonGreen transition-all group">
                            <div class="p-2 bg-neonGreen/10 rounded-lg text-neonGreen"><i data-lucide="upload" class="w-5 h-5"></i></div>
                            <div class="text-left">
                                <span class="block text-sm font-bold text-white group-hover:text-neonGreen transition-colors">Restore Data</span>
                                <span class="block text-[10px] text-slate-400">Pulihkan dari file JSON</span>
                            </div>
                        </button>
                        
                        <button onclick="if(confirm('Yakin ingin menghapus SEMUA data? Aksi ini tidak bisa dibatalkan.')) { localStorage.clear(); location.reload(); }" class="w-full flex items-center gap-3 p-4 rounded-xl bg-surface border border-slate-700 hover:border-neonRed transition-all group mt-6">
                            <div class="p-2 bg-neonRed/10 rounded-lg text-neonRed"><i data-lucide="trash-2" class="w-5 h-5"></i></div>
                            <div class="text-left">
                                <span class="block text-sm font-bold text-white group-hover:text-neonRed transition-colors">Reset Total</span>
                                <span class="block text-[10px] text-slate-400">Hapus semua progress</span>
                            </div>
                        </button>
                    </div>
                </div>`;
                m.classList.remove('opacity-0', 'invisible', 'pointer-events-none');
                lucide.createIcons();
            },

            toggleSound() {
                const newState = !this.sound.muted;
                this.sound.setMuted(newState);
                this.openSettings(); 
                if (!newState) this.sound.play('click');
            },

            exportData() {
                this.sound.play('click');
                const data = {
                    tasks: Store.get('tasks'),
                    rewards: Store.get('rewards'),
                    achievements: Store.get('achievements'), 
                    goals: Store.get('goals'), // EXPORT GOALS
                    blueprints: Store.get('blueprints'), 
                    reflections: Store.get('reflections'),
                    finance: Store.get('finance'),
                    settings: Store.get('settings')
                };
                const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `wakemap_backup_${Utils.getISO()}.json`;
                a.click();
                this.toast('Data berhasil di-backup!', 'success');
            },

            importData() {
                this.sound.play('click');
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = e => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = event => {
                        try {
                            const data = JSON.parse(event.target.result);
                            if (data.tasks) Store.set('tasks', data.tasks);
                            if (data.rewards) Store.set('rewards', data.rewards);
                            if (data.achievements) Store.set('achievements', data.achievements); 
                            if (data.goals) Store.set('goals', data.goals); // IMPORT GOALS
                            if (data.blueprints) Store.set('blueprints', data.blueprints); 
                            if (data.reflections) Store.set('reflections', data.reflections);
                            if (data.finance) Store.set('finance', data.finance);
                            if (data.settings) Store.set('settings', data.settings);
                            this.sound.play('success');
                            this.toast('Data berhasil dipulihkan!', 'success');
                            setTimeout(() => window.location.reload(), 1000);
                        } catch (err) {
                            this.sound.play('error');
                            this.toast('File backup tidak valid', 'error');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            },

            // --- UI HELPERS ---
            toast(msg, type='info') {
                if (type === 'error') this.sound.play('error');
                
                const el = document.getElementById('toast-layer');
                const div = document.createElement('div');
                const cls = { success:'border-neonGreen text-neonGreen', error:'border-neonRed text-neonRed', info:'border-neonCyan text-neonCyan' };
                const ico = { success:'check-circle', error:'alert-circle', info:'info' };
                div.className = `toast-msg border-l-4 ${cls[type]}`;
                div.innerHTML = `<i data-lucide="${ico[type]}" class="w-5 h-5"></i><span class="text-xs font-bold text-white">${msg}</span>`;
                el.appendChild(div);
                lucide.createIcons();
                setTimeout(() => { div.style.animation = 'toastExit 0.4s forwards'; setTimeout(()=>div.remove(), 400); }, 3000);
            },

            openModal() {
                this.sound.play('click');
                const m = document.getElementById('modal-layer');
                m.innerHTML = `
                <div class="bg-charcoal border-t sm:border border-slate-700 rounded-t-3xl sm:rounded-2xl w-full max-w-sm p-6 shadow-2xl pointer-events-auto animate-[slideIn_0.3s_ease-out]">
                    <button onclick="App.controller.closeModal()" class="absolute top-6 right-6 text-slate-500 hover:text-white bg-slate-800/50 p-2 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                    <div class="mb-6"><h3 class="text-xl font-bold text-white mb-1">Time Protocol</h3><p class="text-slate-400 text-xs font-mono">Pilih slot waktu eksekusi:</p></div>
                    <div class="grid grid-cols-2 gap-2 h-64 overflow-y-auto custom-scroll pr-1">
                        ${Config.TIME_SLOTS.map(s => `<button onclick="App.controller.confirmTask('${s.id}')" class="glass-card p-3 rounded-xl hover:border-neonCyan hover:bg-slate-800 text-left group active:scale-95 transition-all"><span class="text-neonCyan font-mono font-bold text-sm block group-hover:text-white transition-colors">${s.label}</span><span class="text-slate-300 text-[10px] block opacity-70">${s.range}</span></button>`).join('')}
                    </div>
                </div>`;
                m.classList.remove('opacity-0', 'invisible', 'pointer-events-none');
                lucide.createIcons();
            },

            closeModal() {
                this.sound.play('click');
                const m = document.getElementById('modal-layer');
                m.classList.add('opacity-0', 'invisible', 'pointer-events-none');
                setTimeout(() => m.innerHTML='', 300);
            },

            // --- RENDER ENGINE ---
            render() {
                // 1. Pre-Check Auto Fails before rendering
                const tasksRaw = Store.get('tasks');
                if(Engine.checkAutoFail(tasksRaw)) { Store.set('tasks', tasksRaw); }

                const tasks = Store.get('tasks');
                const rewards = Store.get('rewards');
                const reflections = Store.get('reflections');
                const financeData = Store.get('finance'); 
                const achievements = Store.get('achievements');
                const goals = Store.get('goals') || []; // Load Goals
                
                const today = Utils.getISO();
                const monthKey = Utils.getISO().slice(0, 7);
                const currentSlot = Utils.getCurrentSlot();
                const currentHour = new Date().getHours();
                
                // Get Current Month Config
                const myFinance = financeData.find(f => f.month === monthKey);
                
                // Update Common Elements
                document.getElementById('header-month').innerText = Utils.formatMonth(monthKey);
                
                // Update Nav
                const navInner = document.getElementById('nav-inner');
                const tabs = [{id:'home',l:'PETA',i:'map'},{id:'rank',l:'RANK',i:'swords'},{id:'rewards',l:'GIFT',i:'gift'},{id:'history',l:'LOGS',i:'history'}];
                navInner.innerHTML = tabs.map(t => {
                    const act = this.state.view === t.id;
                    return `<button onclick="App.controller.navigate('${t.id}')" class="nav-item ${act?'active':''} flex flex-col items-center gap-1.5 p-2 w-16 group"><i data-lucide="${t.i}" class="nav-icon w-5 h-5"></i><span class="text-[8px] font-bold tracking-widest group-hover:text-white">${t.l}</span><div class="nav-indicator"></div></button>`;
                }).join('');

                const main = document.getElementById('app-viewport');
                
                const pts = Engine.calcPoints(tasks);

                if (this.state.view === 'home') {
                    const rnk = Engine.calcRank(monthKey, tasks, financeData);
                    const ref = reflections.find(r => r.date === today);
                    
                    // UPDATED: Logic Filter
                    // Fail: Date today & Status failed (Checked by AutoFail)
                    const tFailed = Engine.sortTasks(tasks.filter(t => t.date === today && t.status === 'failed'));
                    const tCompleted = Engine.sortTasks(tasks.filter(t => t.date === today && t.status === 'completed'));
                    
                    const tActive = Engine.sortTasks(tasks.filter(t => {
                        return t.date === today && t.status === 'pending' && (t.timeSlot === currentSlot.id || t.timeSlot === 'all');
                    }));
                    
                    const tUpcoming = Engine.sortTasks(tasks.filter(t => {
                        if (t.date !== today || t.status !== 'pending') return false;
                        const slot = Config.TIME_SLOTS.find(s => s.id === t.timeSlot);
                        return slot && slot.id !== 'all' && slot.start > currentHour; 
                    }));
                    
                    const tTom = Engine.sortTasks(tasks.filter(t => t.date === Utils.getTomorrow()));

                    const tTomPoints = tTom.reduce((acc, t) => acc + (Config.DIFFICULTY[t.difficulty]?.pts || 0), 0);

                    const diffBtn = (d) => {
                        const act = this.state.difficulty === d;
                        const c = Config.DIFFICULTY[d];
                        return `<button onclick="App.controller.setDifficulty('${d}')" class="flex-1 py-2 rounded-lg text-[10px] font-bold border uppercase transition-all ${act ? `bg-white/10 text-white shadow-[0_0_10px_currentColor] ${c.border}` : 'border-slate-700 text-slate-500'}" style="${act?`color:${c.hex}`:''}">${c.label}</button>`;
                    };

                    // --- FINANCE SETUP CARD ---
                    let financeCard = '';
                    if (!myFinance) {
                        const selectedModeId = this.state.tempMode;
                        financeCard = `
                        <div class="glass-card p-5 rounded-xl border border-neonGold/30 bg-neonGold/5 mb-4 animate-[pulse-slow]">
                            <div class="flex items-center gap-2 mb-3">
                                <i data-lucide="settings-2" class="w-5 h-5 text-neonGold"></i>
                                <h3 class="text-sm font-bold text-white">Kalibrasi Protokol Bulan Ini</h3>
                            </div>
                            <p class="text-xs text-slate-400 mb-3 leading-relaxed">Agar kalkulasi nilai poin & rank akurat, masukkan parameter finansial & pilih mode operasi Anda.</p>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-[9px] text-slate-500 uppercase font-bold mb-1 block">Anggaran/Gaji (Rp)</label>
                                    <input id="income-in" type="number" placeholder="Contoh: 1800000" value="${this.state.tempIncome || ''}" class="w-full bg-obsidian text-white rounded-lg px-3 py-2.5 text-sm border border-slate-700 focus:border-neonGold outline-none transition-colors">
                                </div>
                                <div>
                                    <label class="text-[9px] text-slate-500 uppercase font-bold mb-1 block">Alokasi Self Reward (%)</label>
                                    <select id="alloc-in" class="w-full bg-obsidian text-white rounded-lg px-3 py-2.5 text-sm border border-slate-700 focus:border-neonGold outline-none transition-colors">
                                        <option value="0.1" ${this.state.tempAlloc === '0.1' ? 'selected' : ''}>10% (Mode Konservatif)</option>
                                        <option value="0.2" ${this.state.tempAlloc === '0.2' || !this.state.tempAlloc ? 'selected' : ''}>20% (Mode Seimbang)</option>
                                        <option value="0.3" ${this.state.tempAlloc === '0.3' ? 'selected' : ''}>30% (Mode Agresif)</option>
                                        <option value="0.4" ${this.state.tempAlloc === '0.4' ? 'selected' : ''}>40% (Mode Ekstrem)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-[9px] text-slate-500 uppercase font-bold mb-2 block">Pilih Mode Operasi</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        ${Config.PRODUCTIVITY_MODES.map(m => {
                                            const isSel = selectedModeId === m.id;
                                            const border = isSel ? `border-${m.color.split('-')[1]}` : 'border-slate-700';
                                            const bg = isSel ? 'bg-slate-700' : 'bg-slate-800';
                                            return `
                                            <button onclick="App.controller.selectMode('${m.id}')" class="${bg} border ${border} hover:bg-slate-700 p-2 rounded-lg text-left transition-all active:scale-95 group relative overflow-hidden">
                                                ${isSel ? `<div class="absolute inset-0 bg-white/5"></div>` : ''}
                                                <div class="flex items-center gap-2 mb-1">
                                                    <i data-lucide="${m.icon}" class="w-3 h-3 ${m.color}"></i>
                                                    <span class="text-xs font-bold text-white">${m.label}</span>
                                                </div>
                                                <div class="flex justify-between items-center">
                                                    <span class="text-[9px] text-slate-400">${m.desc}</span>
                                                    <span class="text-[10px] font-mono font-bold ${m.color}">${m.pts} Pts</span>
                                                </div>
                                            </button>`;
                                        }).join('')}
                                    </div>
                                </div>
                                <button onclick="App.controller.saveMonthlyConfig()" class="w-full bg-neonGold text-obsidian px-4 py-3 rounded-lg font-bold hover:bg-white transition-colors shadow-lg mt-2 flex justify-center items-center gap-2"><i data-lucide="check-circle" class="w-4 h-4"></i> Simpan Parameter</button>
                            </div>
                        </div>`;
                    }

                    main.innerHTML = `
                    <div class="space-y-8 pb-10 animate-[fadeIn_0.4s_ease-out]">
                        
                        ${financeCard}

                        <div class="flex gap-4">${ComponentFactory.rankCard('EXECUTION', rnk.exec, 'swords')}${ComponentFactory.rankCard('CONSISTENCY', rnk.cons, 'zap')}</div>
                        
                        ${ComponentFactory.analyticsCard(tasks)}

                        <!-- Poin Hari Ini -->
                        <div class="glass-card p-5 rounded-xl flex items-center justify-between relative overflow-hidden">
                            <div class="absolute right-0 top-0 h-full w-1/2 bg-gradient-to-l from-neonCyan/10 to-transparent"></div>
                            <div class="relative z-10"><div class="text-[9px] text-neonCyan font-bold uppercase tracking-widest mb-1">Poin Hari Ini</div><div class="text-4xl font-mono font-bold text-white drop-shadow-md">${pts.cur} <span class="text-xs text-slate-500 font-sans font-normal">/ ${myFinance ? myFinance.targetPts : '-'} PTS</span></div></div>
                            <div class="relative z-10 w-12 h-12 rounded-full bg-slate border border-white/10 flex items-center justify-center"><i data-lucide="activity" class="text-neonCyan w-6 h-6"></i></div>
                        </div>

                        <!-- Rata-rata Harian -->
                        <div class="glass-card p-3 rounded-xl flex items-center justify-between border-l-2 border-neonPurple bg-white/5">
                            <div class="flex items-center gap-3">
                                <div class="p-2 rounded-lg bg-neonPurple/10"><i data-lucide="trending-up" class="w-4 h-4 text-neonPurple"></i></div>
                                <div>
                                    <p class="text-[9px] text-neonPurple font-bold uppercase tracking-widest">Rata-rata Harian</p>
                                    <p class="text-[8px] text-slate-400 font-mono">Performa Bulan Ini</p>
                                </div>
                            </div>
                            <div class="text-xl font-mono font-bold text-white tracking-wide">${pts.avg} <span class="text-[9px] text-slate-500 font-sans font-normal">PTS</span></div>
                        </div>

                        <!-- Stats Bulanan Grid -->
                        <div class="grid grid-cols-2 gap-3">
                            <div class="glass-card p-4 flex flex-col items-center border-t-2 border-slate-600">
                                <span class="text-[8px] text-slate-400 uppercase tracking-widest mb-1">Bulan Lalu</span>
                                <span class="text-xl font-mono font-bold text-slate-300">${pts.last}</span>
                            </div>
                            <div class="glass-card p-4 flex flex-col items-center border-t-2 border-neonCyan">
                                <span class="text-[8px] text-neonCyan uppercase tracking-widest mb-1">Bulan Ini</span>
                                <span class="text-xl font-mono font-bold text-white">${pts.mon}</span>
                            </div>
                        </div>

                        ${ref ? `<div class="glass-card p-5 rounded-xl border-l-4 border-l-neonPurple"><div class="flex items-center gap-2 mb-2 text-neonPurple"><i data-lucide="brain-circuit" class="w-4 h-4"></i><span class="text-[10px] font-bold uppercase tracking-widest">LOG REFLEKSI</span></div><p class="text-sm text-slate-200 italic">"${ref.text}"</p></div>` : 
                        `<div class="p-5 rounded-xl border border-dashed border-slate-700 bg-slate/20"><label class="block text-slate-400 text-[10px] font-bold mb-3 uppercase tracking-widest flex items-center gap-2"><i data-lucide="edit-3" class="w-3 h-3"></i> Refleksi Wajib</label><div class="flex gap-2"><input id="ref-in" type="text" placeholder="Apa yang dipelajari?" class="flex-1 bg-charcoal text-white rounded-lg px-4 py-3 text-sm border border-slate-700 focus:border-neonPurple outline-none"><button onclick="App.controller.saveRef()" class="bg-neonPurple text-white px-4 rounded-lg shadow-lg"><i data-lucide="save" class="w-4 h-4"></i></button></div></div>`}

                        <!-- SECTION: MISI GAGAL -->
                        ${tFailed.length > 0 ? `
                        <div>
                             <div class="flex justify-between mb-2 items-center border-b border-neonRed/20 pb-2">
                                <h2 class="text-sm font-bold text-neonRed flex items-center gap-2"><i data-lucide="alert-octagon" class="w-4 h-4"></i> TERLEWAT / GAGAL</h2>
                            </div>
                            <div class="space-y-0">${tFailed.map(t => ComponentFactory.taskItem(t, true)).join('')}</div>
                        </div>` : ''}

                          <!-- SECTION: MISI SELESAI -->
                        ${tCompleted.length > 0 ? `
                        <div>
                             <div class="flex justify-between mb-2 items-center border-b border-neonGreen/20 pb-2">
                                <h2 class="text-sm font-bold text-neonGreen flex items-center gap-2"><i data-lucide="check-circle-2" class="w-4 h-4"></i> SELESAI / SUKSES</h2>
                            </div>
                            <div class="space-y-0">${tCompleted.map(t => ComponentFactory.taskItem(t, true)).join('')}</div>
                        </div>` : ''}

                        <!-- SECTION: MISI AKTIF -->
                        <div>
                            <div class="flex justify-between mb-4 items-end border-b border-white/5 pb-2">
                                <h2 class="text-sm font-bold text-white flex items-center gap-2"><i data-lucide="crosshair" class="w-4 h-4 text-neonCyan"></i> MISI AKTIF</h2>
                                <div class="flex flex-col items-end">
                                    <span class="text-[9px] text-neonCyan font-mono font-bold uppercase tracking-widest">${currentSlot.label} PHASE</span>
                                    <span class="text-[8px] text-slate-500 font-mono">${currentSlot.range}</span>
                                </div>
                            </div>
                            <div class="space-y-0">${tActive.length===0 ? '<div class="text-center py-8 text-xs text-slate-600 font-mono border border-dashed border-slate-800 rounded-xl">ISTIRAHAT / FASE KOSONG</div>' : tActive.map(t => ComponentFactory.taskItem(t, true)).join('')}</div>
                        </div>

                        <!-- SECTION: MISI AKAN DATANG -->
                        ${tUpcoming.length > 0 ? `
                        <div>
                             <div class="flex justify-between mb-2 items-center border-b border-neonPurple/20 pb-2">
                                <h2 class="text-sm font-bold text-neonPurple flex items-center gap-2"><i data-lucide="clock" class="w-4 h-4"></i> AKAN DATANG HARI INI</h2>
                            </div>
                            <div class="space-y-0 opacity-80">${tUpcoming.map(t => ComponentFactory.taskItem(t, true)).join('')}</div>
                        </div>` : ''}

                        <div class="flex items-center justify-center opacity-20 py-2"><div class="h-px bg-white w-full"></div><div class="mx-4 text-[9px] font-mono text-white whitespace-nowrap">NEXT CYCLE</div><div class="h-px bg-white w-full"></div></div>

                        <!-- SECTION: PERENCANAAN BESOK -->
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-sm font-bold text-white flex items-center gap-2"><i data-lucide="sunrise" class="w-4 h-4 text-neonGold"></i> PERENCANAAN BESOK</h2>
                                <span class="text-[10px] font-mono text-neonGold border border-neonGold/30 px-2 py-1 rounded bg-neonGold/10">POTENSI: +${tTomPoints} PTS</span>
                            </div>
                            <div class="glass-card p-5 rounded-xl space-y-4 mb-4 relative group">
                                <!-- Blueprint Button -->
                                <button onclick="App.controller.openBlueprintManager()" class="absolute top-5 right-5 text-neonCyan hover:text-white bg-neonCyan/10 p-1.5 rounded-lg border border-neonCyan/20 transition-all active:scale-95" title="Blueprint System">
                                    <i data-lucide="folder-open" class="w-4 h-4"></i>
                                </button>

                                <input id="task-in" type="text" placeholder="Input nama misi..." value="${this.state.tempTaskInput || ''}" class="w-full bg-charcoal text-white rounded-lg px-4 py-3 text-sm border border-slate-700 focus:border-neonCyan outline-none pr-12">
                                <div class="flex gap-2">${['easy','medium','hard'].map(diffBtn).join('')}</div>
                                <div class="flex gap-2">
                                    <button onclick="App.controller.initTask()" class="flex-1 btn-action bg-neonCyan hover:bg-white hover:text-obsidian text-obsidian font-bold py-3 rounded-lg text-xs uppercase tracking-widest shadow-[0_0_15px_rgba(6,182,212,0.3)] flex justify-center gap-2"><i data-lucide="plus-circle" class="w-4 h-4"></i> Jadwalkan</button>
                                </div>
                            </div>
                            <div class="space-y-0">${tTom.map(t => ComponentFactory.taskItem(t, false)).join('')}</div>
                        </div>
                    </div>`;
                } 
                else if (this.state.view === 'rank') {
                    const rnk = Engine.calcRank(monthKey, tasks, financeData);
                    let hHtml = '';
                    for(let i=1; i<=3; i++) {
                        const d = new Date(); d.setMonth(d.getMonth()-i);
                        const k = Utils.getISO(d).slice(0,7);
                        const r = Engine.calcRank(k, tasks, financeData);
                        hHtml += `
                        <div class="glass-card px-4 py-3 rounded-xl flex items-center justify-between mb-2">
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">${Utils.formatMonth(k)}</span>
                            <div class="flex gap-4">
                                <div class="flex items-center gap-2" title="Execution Rank">
                                    <span class="text-[8px] font-mono text-slate-600">EXEC</span>
                                    <span class="font-display text-base ${r.exec.tier.class}">${r.exec.tier.code}</span>
                                </div>
                                <div class="w-px h-4 bg-white/5"></div>
                                <div class="flex items-center gap-2" title="Consistency Rank">
                                    <span class="text-[8px] font-mono text-slate-600">CONS</span>
                                    <span class="font-display text-base ${r.cons.tier.class}">${r.cons.tier.code}</span>
                                </div>
                            </div>
                        </div>`;
                    }
                    main.innerHTML = `
                    <div class="space-y-8 animate-[fadeIn_0.4s_ease-out] pt-4">
                        <div class="text-center"><div class="inline-block px-6 py-2 rounded-full border border-neonCyan/30 bg-neonCyan/10 backdrop-blur-md mb-2"><h2 class="text-neonCyan font-black text-sm uppercase tracking-[0.2em] drop-shadow-[0_0_10px_rgba(6,182,212,0.5)]">${Utils.formatMonth(monthKey)}</h2></div><p class="text-[10px] text-slate-500 uppercase tracking-widest">Laporan Kinerja Bulanan</p></div>
                        <div class="flex flex-col gap-4">${ComponentFactory.rankCard('EXECUTION RANK', rnk.exec, 'swords')}<div class="text-center text-[9px] text-slate-500 font-mono -mt-2 mb-2">SYARAT: SEMUA SELESAI (2x)</div>${ComponentFactory.rankCard('CONSISTENCY RANK', rnk.cons, 'zap')}<div class="text-center text-[9px] text-slate-500 font-mono -mt-2">SYARAT: CAPAI TARGET HARIAN (${rnk.dailyTarget} PTS)</div></div>
                        
                        <!-- NEW: Active Goal Section -->
                        <div class="pt-4 border-t border-white/5">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2"><i data-lucide="target" class="w-3 h-3 text-neonPurple"></i> Target Aktif</h3>
                                <button onclick="App.controller.openGoalModal()" class="text-[9px] bg-surface hover:bg-slate-700 text-neonPurple px-2 py-1 rounded border border-slate-700 flex items-center gap-1"><i data-lucide="plus" class="w-3 h-3"></i> SET GOAL</button>
                            </div>
                            ${goals.length === 0 
                                ? `<div class="text-center py-6 text-[10px] text-slate-600 border border-dashed border-slate-800 rounded-xl italic">Belum ada target aktif.</div>` 
                                : `<div class="flex gap-3 overflow-x-auto pb-4 hide-scroll">${goals.map(g => ComponentFactory.goalCard(g)).join('')}</div>`
                            }
                        </div>

                        <!-- Updated: Achievement Section (Hall of Fame) -->
                        <div class="pt-4 border-t border-white/5">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2"><i data-lucide="medal" class="w-3 h-3 text-neonGold"></i> Hall of Fame (Riwayat)</h3>
                            </div>
                            
                            ${achievements.length === 0 
                                ? `<div class="text-center py-6 text-[10px] text-slate-600 border border-dashed border-slate-800 rounded-xl italic">Belum ada pencapaian legendaris.</div>` 
                                : `<div class="grid grid-cols-3 gap-2">
                                    ${Object.values(achievements.reduce((acc, a) => {
                                        if (!acc[a.goalId] || new Date(a.dateUnlocked) > new Date(acc[a.goalId].latest.dateUnlocked)) {
                                            acc[a.goalId] = { latest: a, count: (acc[a.goalId] ? acc[a.goalId].count + 1 : 1), all: (acc[a.goalId] ? [...acc[a.goalId].all, a] : [a]) };
                                        } else {
                                            acc[a.goalId].count++;
                                            acc[a.goalId].all.push(a);
                                        }
                                        return acc;
                                    }, {})).map(group => {
                                        if (group.count > 1 || goals.find(g => g.id === group.latest.goalId)?.type === 'progressive') {
                                            // Render Stack for progressive or multiple items
                                            return ComponentFactory.achievementStack(group.latest.goalId, group.all.sort((a,b) => new Date(a.dateUnlocked) - new Date(b.dateUnlocked)));
                                        } else {
                                            // Render Single
                                            return ComponentFactory.achievementBadge(group.latest);
                                        }
                                    }).join('')}
                                  </div>`
                            }
                            <p class="text-[8px] text-slate-600 mt-2 text-center">Rekaman sejarah tidak bisa diubah.</p>
                        </div>

                        <div class="pt-4 border-t border-white/5"><h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2"><i data-lucide="archive" class="w-3 h-3"></i> Arsip Bulanan</h3>${hHtml}</div>
                        <div class="pt-4 border-t border-white/5"><h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2"><i data-lucide="list" class="w-3 h-3"></i> Codex Pangkat</h3><div class="bg-charcoal/50 p-2 rounded-xl border border-white/5 h-64 overflow-y-auto custom-scroll">${ComponentFactory.rankLegend()}</div></div>
                    </div>`;
                }
                else if (this.state.view === 'rewards') {
                    const { mon } = pts;
                    const active = rewards.filter(r => r.status === 'active');
                    const redeemed = rewards.filter(r => r.status === 'redeemed').sort((a,b)=>new Date(b.redeemedDate)-new Date(a.redeemedDate));
                    
                    const curMonthKey = Utils.getMonthKey(Utils.getISO());
                    const myFinance = financeData.find(f => f.month === curMonthKey);
                    
                    let financeSection = '';
                    if (!myFinance) {
                         financeSection = `<div class="glass-card p-4 rounded-xl border border-neonGold/30 bg-neonGold/5 mb-4"><p class="text-xs text-white text-center"> Harap kalibrasi data finansial di menu <strong>PETA</strong> untuk membuka fitur kalkulasi otomatis.</p></div>`;
                    } else {
                        const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
                        const allocation = myFinance.allocation || 0.2;
                        const dailyBudget = (myFinance.amount * allocation) / daysInMonth;
                        
                        const dailyTarget = myFinance.targetPts || 10;
                        const valPerPoint = Math.max(1, Math.round(dailyBudget / dailyTarget));
                        
                        const mode = Config.PRODUCTIVITY_MODES.find(m => m.id === myFinance.modeId) || { label: 'Custom', color: 'text-white' };
                        
                        financeSection = `
                        <div class="mb-4 flex justify-between items-center text-[10px] text-slate-500 font-mono border-b border-white/5 pb-2">
                            <span>MODE: <span class="${mode.color} font-bold">${mode.label.toUpperCase()}</span></span>
                            <span title="Berdasarkan Alokasi ${allocation*100}%">1 PTS  Rp ${Utils.formatCurrency(valPerPoint)}</span>
                        </div>`;
                    }

                    // Reward Form Logic
                    let rewardForm = '';
                    if (this.state.rewardStep === 0) {
                        rewardForm = `
                        <div class="flex gap-2">
                            <input id="rew-name" type="text" placeholder="Nama hadiah..." class="w-full bg-charcoal text-white rounded-lg px-4 py-3 text-sm border border-slate-700 focus:border-neonCyan outline-none">
                            <button onclick="App.controller.initReward()" class="bg-neonCyan hover:bg-white hover:text-obsidian text-obsidian px-5 rounded-lg font-bold transition-all shadow-lg"><i data-lucide="arrow-right" class="w-5 h-5"></i></button>
                        </div>`;
                    } else if (this.state.rewardStep === 1) {
                        rewardForm = `
                        <div class="text-center py-2 animate-[fadeIn_0.3s]">
                            <p class="text-white text-xs font-bold mb-3">Apakah hadiah ini memiliki harga nominal (Rp)?</p>
                            <div class="flex gap-3 justify-center">
                                <button onclick="App.controller.setRewardHasPrice(false)" class="px-4 py-2 rounded-lg border border-slate-600 text-slate-300 hover:bg-slate-700 text-xs">Tidak</button>
                                <button onclick="App.controller.setRewardHasPrice(true)" class="px-4 py-2 rounded-lg bg-neonPurple text-white hover:bg-neonPurple/80 shadow-lg text-xs font-bold">Ya, Ada</button>
                            </div>
                        </div>`;
                    } else if (this.state.rewardStep === 2) {
                        const showPriceInput = this.state.tempReward.hasPrice;
                        rewardForm = `
                        <div class="space-y-3 animate-[fadeIn_0.3s]">
                            <div class="flex items-center justify-between text-xs text-slate-400 px-1"><span>Item: <strong class="text-white">${this.state.tempReward.name}</strong></span><button onclick="App.controller.resetRewardForm()" class="text-neonRed hover:underline">Batal</button></div>
                            ${showPriceInput ? `<input id="rew-price" type="number" onkeyup="App.controller.calcRewardRecs()" placeholder="Masukkan Harga (Rp)..." class="w-full bg-charcoal text-white rounded-lg px-4 py-3 text-sm border border-slate-700 focus:border-neonPurple outline-none">` : ''}
                            
                            <div id="rec-container"></div>

                            <div class="flex gap-2">
                                <input id="rew-cost" type="number" placeholder="Target Poin (Contoh: 50)" class="flex-1 bg-charcoal text-white rounded-lg px-4 py-3 text-sm border border-slate-700 focus:border-neonCyan outline-none">
                                <button onclick="App.controller.saveReward()" class="bg-neonCyan hover:bg-white hover:text-obsidian text-obsidian px-5 rounded-lg font-bold transition-all shadow-lg"><i data-lucide="check" class="w-5 h-5"></i></button>
                            </div>
                        </div>`;
                    }

                    main.innerHTML = `
                    <div class="space-y-6 animate-[fadeIn_0.4s_ease-out] pt-4">
                        <div class="glass-card p-8 rounded-2xl text-center relative overflow-hidden"><div class="absolute inset-0 bg-gradient-to-br from-neonCyan/10 to-transparent"></div><p class="text-neonCyan mb-2 text-[10px] uppercase tracking-[0.3em] font-bold relative z-10">SALDO POIN</p><p class="text-6xl font-black text-white drop-shadow-[0_0_20px_rgba(6,182,212,0.5)] font-mono relative z-10">${Utils.formatCurrency(mon)}</p></div>
                        
                        ${financeSection}

                        <div class="space-y-2"><h3 class="text-xs font-bold text-white uppercase tracking-widest pl-2 border-l-2 border-neonCyan">Target Baru</h3><div class="glass-card p-4 rounded-xl space-y-3">${rewardForm}</div></div>
                        <div class="space-y-3"><h3 class="text-xs font-bold text-white uppercase tracking-widest pl-2 border-l-2 border-neonPurple">Wishlist</h3>${active.length===0?'<div class="text-center py-8 text-xs text-slate-600 border border-dashed border-slate-800 rounded-xl">KOSONG</div>':active.map(r=>{const p=Math.min((mon/r.cost)*100,100); const col=mon>=r.cost?'bg-neonGreen':'bg-gradient-to-r from-neonCyan to-neonPurple'; return `
                        <div class="glass-card p-4 rounded-xl relative overflow-hidden group">
                            <div class="absolute bottom-0 left-0 h-1 ${col} transition-all duration-1000 shadow-[0_0_10px_currentColor]" style="width:${p}%"></div>
                            <div class="flex justify-between items-center relative z-10">
                                <div>
                                    <p class="text-white text-sm font-bold group-hover:text-neonCyan transition-colors">${r.name}</p>
                                    ${r.price ? `<p class="text-[10px] text-neonGold font-mono mb-0.5">Rp ${Utils.formatCurrency(r.price)}</p>` : ''}
                                    <p class="text-[10px] text-slate-400 mt-0.5 font-mono tracking-wide">Progress: ${Utils.formatCurrency(mon)} / <span class="text-white">${Utils.formatCurrency(r.cost)} PTS</span></p>
                                </div>
                                <button onclick="App.controller.delReward('${r.id}')" class="text-slate-600 hover:text-neonRed transition-colors p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>`}).join('')}</div>
                        <div class="pt-4 border-t border-white/5 space-y-3"><h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest pl-2 border-l-2 border-slate-600">Riwayat Klaim</h3>${redeemed.length===0?'<div class="text-center py-4 text-xs text-slate-700">Belum ada.</div>':redeemed.map(r=>`<div class="glass-card p-3 rounded-lg flex items-center justify-between opacity-70"><div><p class="text-white text-xs font-bold">${r.name}</p><p class="text-[9px] text-slate-500">${Utils.formatDate(r.redeemedDate)}</p></div><div class="text-neonGreen text-[10px] font-mono flex items-center gap-1"><i data-lucide="check-circle" class="w-3 h-3"></i> TUKAR</div></div>`).join('')}</div>
                    </div>`;
                }
                else if (this.state.view === 'history') {
                    const [hy, hm] = this.state.histMonth.split('-');
                    const dim = new Date(hy, hm, 0).getDate();
                    const fDay = new Date(hy, parseInt(hm)-1, 1).getDay();
                    const offset = fDay===0?6:fDay-1;
                    const days = Array.from({length:dim},(_,i)=>`${this.state.histMonth}-${String(i+1).padStart(2,'0')}`);
                    const sd = this.state.histDate;
                    
                    // UPDATED: Sorted tasks for history details
                    const sTasks = sd ? Engine.sortTasks(tasks.filter(t=>t.date===sd)) : [];
                    const sRef = sd ? reflections.find(r=>r.date===sd) : null;
                    const histRank = Engine.calcRank(this.state.histMonth, tasks, financeData);

                    let grid = '';
                    for(let i=0;i<offset;i++) grid+=`<div class="aspect-square"></div>`;
                    days.forEach(d => {
                        const dayTasks = tasks.filter(t=>t.date===d);
                        const has = dayTasks.length>0;
                        const all = has && dayTasks.every(t=>t.status==='completed');
                        const fail = dayTasks.some(t=>t.status==='failed');
                        let bg='bg-slate-800/30 text-slate-500', br='border-transparent';
                        if(has) { if(all){bg='bg-neonGreen/20 text-white';br='border-neonGreen/50'} else if(fail){bg='bg-neonRed/20 text-white';br='border-neonRed/50'} else {bg='bg-neonPurple/20 text-white';br='border-neonPurple/50'} }
                        if(sd===d) { bg='bg-neonCyan text-obsidian font-bold shadow-[0_0_10px_rgba(6,182,212,0.5)]'; br='border-white'; }
                        grid+=`<button onclick="App.controller.setDate('${d}')" class="cal-cell ${sd===d?'active':''} aspect-square rounded-lg flex items-center justify-center text-xs border ${br} ${bg} transition-all hover:scale-105 active:scale-95">${new Date(d).getDate()}</button>`;
                    });

                    main.innerHTML = `
                    <div class="pt-2 animate-[fadeIn_0.4s_ease-out] pb-24">
                        
                        <!-- Month Nav -->
                        <div class="flex items-center justify-between glass-card p-2 rounded-xl mb-4">
                            <button onclick="App.controller.navMonth(-1)" class="p-2 hover:bg-white/10 rounded-lg text-slate-400 group">
                                <i data-lucide="chevron-left" class="w-5 h-5 group-active:-translate-x-1 transition-transform"></i>
                            </button>
                            <span class="text-white font-black text-sm tracking-[0.2em]">${Utils.formatMonth(this.state.histMonth)}</span>
                            <button onclick="App.controller.navMonth(1)" class="p-2 hover:bg-white/10 rounded-lg text-slate-400 group">
                                <i data-lucide="chevron-right" class="w-5 h-5 group-active:translate-x-1 transition-transform"></i>
                            </button>
                        </div>

                        <!-- Monthly Rank History Display -->
                        <div class="flex gap-3 mb-6">
                            ${ComponentFactory.rankCard('EXECUTION', histRank.exec, 'swords')}
                            ${ComponentFactory.rankCard('CONSISTENCY', histRank.cons, 'zap')}
                        </div>

                        <!-- Calendar Grid -->
                        <div class="grid grid-cols-7 gap-1 text-center mb-2">${['SEN','SEL','RAB','KAM','JUM','SAB','MIN'].map(d=>`<div class="text-[8px] font-bold text-slate-500 tracking-wider">${d}</div>`).join('')}</div>
                        <div class="grid grid-cols-7 gap-1.5 mb-6">${grid}</div>
                        
                        <!-- Selected Date Details -->
                        <div class="space-y-4 border-t border-white/5 pt-4">
                            ${!sd ? `<div class="text-center text-slate-600 text-xs font-mono pt-4 flex flex-col items-center gap-2"><i data-lucide="touchpad" class="w-8 h-8 opacity-50"></i>PILIH TANGGAL</div>` : 
                            `<div class="flex justify-between items-center mb-2"><h3 class="text-neonCyan font-bold text-lg">${Utils.formatDate(sd)}</h3><span class="text-[10px] bg-slate px-2 py-1 rounded text-slate-400 font-mono border border-slate-700">LOG</span></div>
                            <div class="glass-card p-4 rounded-xl mb-4 relative overflow-hidden"><div class="absolute top-0 right-0 p-3 opacity-10"><i data-lucide="brain-circuit" class="w-12 h-12 text-white"></i></div><div class="text-[9px] text-neonPurple font-bold uppercase mb-2 tracking-wider">Refleksi</div><p class="text-slate-300 text-sm italic relative z-10">"${sRef ? sRef.text : 'Tidak ada catatan.'}"</p></div>
                            <div class="space-y-0">${sTasks.length === 0 ? '<p class="text-center text-xs text-slate-600 py-8">Tidak ada misi.</p>' : sTasks.map(t => ComponentFactory.taskItem(t, false)).join('')}</div>`}
                        </div>
                    </div>`;
                }

                lucide.createIcons();
            }
        };

        const App = { controller: Controller };
        window.addEventListener('DOMContentLoaded', () => App.controller.init());

    </script>
</body>
</html>
